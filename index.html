<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¶³çƒè®©çƒ/å¤§å°ç›˜å£è®°å½•è½¯ä»¶</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ï¼Œæ–°å¢ä»¥ä¸‹æ ·å¼ */
        .handicap-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eaeaea;
        }

        .handicap-tab {
            flex: 1;
            padding: 12px 16px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px 8px 0 0;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 4px;
            color: #666;
        }

        .handicap-tab.active {
            background: #2a5298;
            color: white;
        }

        .handicap-tab:last-child {
            margin-right: 0;
        }

        .handicap-content {
            display: none;
        }

        .handicap-content.active {
            display: block;
        }

        .size-recommendation-up {
            color: #28a745;
            background-color: rgba(40, 167, 69, 0.08);
            border: 2px solid #28a745;
        }

        .size-recommendation-down {
            color: #dc3545;
            background-color: rgba(220, 53, 69, 0.08);
            border: 2px solid #dc3545;
        }

        .size-recommendation-neutral {
            color: #6c757d;
            background-color: rgba(108, 117, 125, 0.08);
            border: 2px solid #6c757d;
        }

        .recommendation-label {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recommendation-label i {
            margin-right: 8px;
            font-size: 18px;
        }

        .dual-recommendation {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .recommendation-box {
            flex: 1;
            background-color: white;
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        /* è°ƒæ•´å†å²è¡¨æ ¼åˆ—å®½ */
        .history-table th:nth-child(1) {
            width: 120px;
        }

        .history-table th:nth-child(2) {
            width: 80px;
        }

        .history-table th:nth-child(3) {
            width: 100px;
        }

        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ï¼Œåªæ·»åŠ æ–°å¢éƒ¨åˆ† */
        .user-section {
            position: absolute;
            top: 16px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            color: white;
            font-size: 14px;
            text-align: right;
        }

        .user-name {
            font-weight: 600;
        }

        .user-type {
            font-size: 12px;
            opacity: 0.85;
        }

        .user-actions {
            display: flex;
            gap: 6px;
        }

        .user-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 400px;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            color: #1e3c72;
            margin: 0 0 8px 0;
            font-weight: 600;
        }

        .modal-subtitle {
            color: #666;
            font-size: 14px;
            margin: 0;
        }

        .modal-form {
            margin-bottom: 20px;
        }

        .form-row {
            margin-bottom: 16px;
        }

        .modal-form label {
            display: block;
            margin-bottom: 6px;
            color: #444;
            font-weight: 600;
            font-size: 14px;
        }

        .modal-form input,
        .modal-form select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s;
        }

        .modal-form input:focus,
        .modal-form select:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 2px rgba(42, 82, 152, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }

        .modal-buttons button {
            flex: 1;
        }

        .modal-link {
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
            color: #666;
        }

        .modal-link a {
            color: #2a5298;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-link a:hover {
            text-decoration: underline;
        }

        .error-message {
            color: #dc3545;
            font-size: 13px;
            margin-top: 6px;
            display: none;
        }

        .trial-info {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
        }

        .trial-count {
            font-weight: bold;
            color: #e74c3c;
        }

        .admin-link {
            position: absolute;
            top: 16px;
            left: 20px;
        }

        .admin-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .admin-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            font-size: 14px;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 16px 20px;
            text-align: center;
            position: relative;
        }

        h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .subtitle {
            opacity: 0.85;
            font-size: 13px;
            margin-top: 4px;
        }

        .main-content {
            padding: 15px;
        }

        .input-section,
        .result-section,
        .history-section {
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .input-section {
            background-color: #f9f9f9;
            border: 1px solid #eaeaea;
        }

        .result-section {
            background-color: #f0f7ff;
            border: 1px solid #cce0ff;
        }

        .history-section {
            background-color: #fff9e6;
            border: 1px solid #ffeaa7;
        }

        .section-title {
            font-size: 17px;
            color: #1e3c72;
            margin-top: 0;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(30, 60, 114, 0.15);
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #444;
            font-size: 14px;
        }

        select,
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s;
            background-color: white;
            -webkit-appearance: none;
            appearance: none;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 2px rgba(42, 82, 152, 0.1);
        }

        .btn {
            background-color: #2a5298;
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
            margin-right: 8px;
            margin-top: 8px;
            width: 100%;
            display: block;
        }

        .btn:hover,
        .btn:active {
            background-color: #1e3c72;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover,
        .btn-secondary:active {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: #28a745;
        }

        .btn-success:hover,
        .btn-success:active {
            background-color: #218838;
        }

        .btn-danger {
            background-color: #dc3545;
        }

        .btn-danger:hover,
        .btn-danger:active {
            background-color: #c82333;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .button-group .btn {
            flex: 1;
            margin: 0;
            padding: 12px 10px;
        }

        .chart-container {
            width: 100%;
            height: 280px;
            margin-top: 15px;
        }

        .history-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .history-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            min-width: 600px;
        }

        .history-table th {
            background-color: #1e3c72;
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
        }

        .history-table td {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .history-table tr:last-child td {
            border-bottom: none;
        }

        .history-table tr:hover {
            background-color: #f8f9fa;
        }

        .hidden {
            display: none;
        }

        .status-up {
            color: #28a745;
            font-weight: 600;
        }

        .status-down {
            color: #dc3545;
            font-weight: 600;
        }

        .record-action {
            padding: 6px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .record-edit {
            background-color: #ffc107;
            color: #212529;
        }

        .record-delete {
            background-color: #dc3545;
            color: white;
        }

        .auto-calculation-note {
            font-size: 13px;
            color: #666;
            font-style: italic;
            margin-top: 12px;
            text-align: center;
            line-height: 1.4;
        }

        footer {
            text-align: center;
            padding: 16px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
            line-height: 1.4;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .main-content {
                padding: 12px;
            }

            .input-section,
            .result-section,
            .history-section {
                padding: 14px;
                margin-bottom: 12px;
            }

            .section-title {
                font-size: 16px;
                margin-bottom: 14px;
            }

            select,
            input {
                padding: 14px;
                font-size: 16px;
                /* å¢åŠ å­—ä½“å¤§å°ä¾¿äºè§¦æ‘¸ */
            }

            .btn {
                padding: 16px;
                font-size: 16px;
            }

            .recommendation-result {
                font-size: 24px;
                padding: 16px;
            }

            .chart-container {
                height: 250px;
            }

            .history-table th,
            .history-table td {
                padding: 8px 6px;
                font-size: 12px;
            }

            .user-section {
                position: static;
                margin-top: 15px;
                justify-content: center;
            }

            .admin-link {
                position: static;
                margin-bottom: 10px;
                text-align: center;
            }

            .handicap-tab {
                padding: 10px 12px;
                font-size: 14px;
            }

            .dual-recommendation {
                flex-direction: column;
                gap: 10px;
            }

            .history-table {
                min-width: 700px;
            }
        }

        /* å°å±å¹•æ‰‹æœºä¼˜åŒ– */
        @media (max-width: 480px) {
            h1 {
                font-size: 18px;
            }

            .subtitle {
                font-size: 12px;
            }

            .recommendation-result {
                font-size: 22px;
                padding: 14px;
            }

            .chart-container {
                height: 220px;
            }

            .button-group {
                flex-direction: column;
                gap: 6px;
            }

            .history-table th {
                font-size: 12px;
                padding: 10px 6px;
            }

            .history-table td {
                font-size: 11px;
                padding: 8px 5px;
            }

            .modal-content {
                padding: 20px;
                width: 95%;
            }

            .modal-buttons {
                flex-direction: column;
            }
        }

        /* é˜²æ­¢iOS safariçš„ç¼©æ”¾ */
        input,
        select,
        textarea {
            font-size: 16px !important;
        }

        /* è§¦æ‘¸åé¦ˆä¼˜åŒ– */
        .btn:active,
        .record-action:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        /* ä¸‹æ‹‰é€‰æ‹©æ¡†ä¼˜åŒ– */
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }
    </style>
</head>
<body>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç”¨æˆ·ç™»å½•</h2>
                <p class="modal-subtitle">è¯·ä½¿ç”¨æ‚¨çš„è´¦æˆ·ç™»å½•</p>
            </div>
            <div class="modal-form">
                <div class="form-row">
                    <label for="loginUsername">ç”¨æˆ·å</label>
                    <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                    <div id="loginUsernameError" class="error-message"></div>
                </div>
                <div class="form-row">
                    <label for="loginPassword">å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                    <div id="loginPasswordError" class="error-message"></div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn" id="loginBtn">ç™»å½•</button>
                <button class="btn btn-secondary" id="cancelLoginBtn">å–æ¶ˆ</button>
            </div>
            <div class="modal-link">
                è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ <a id="showRegisterLink">ç«‹å³æ³¨å†Œ</a>
            </div>
        </div>
    </div>

    <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç”¨æˆ·æ³¨å†Œ</h2>
                <p class="modal-subtitle">æ³¨å†Œæˆä¸ºæ­£å¼ä¼šå‘˜ï¼Œäº«å—æ— é™åˆ¶è®°å½•åŠŸèƒ½</p>
            </div>
            <div class="modal-form">
                <div class="form-row">
                    <label for="registerUsername">ç”¨æˆ·å</label>
                    <input type="text" id="registerUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆè‡³å°‘3ä¸ªå­—ç¬¦ï¼‰">
                    <div id="registerUsernameError" class="error-message"></div>
                </div>
                <div class="form-row">
                    <label for="registerPassword">å¯†ç </label>
                    <input type="password" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰">
                    <div id="registerPasswordError" class="error-message"></div>
                </div>
                <div class="form-row">
                    <label for="registerConfirmPassword">ç¡®è®¤å¯†ç </label>
                    <input type="password" id="registerConfirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                    <div id="registerConfirmPasswordError" class="error-message"></div>
                </div>
                <div class="form-row">
                    <label for="invitationCode">é‚€è¯·ç </label>
                    <select id="invitationCode">
                        <option value="">è¯·é€‰æ‹©é‚€è¯·ç </option>
                        <!-- é‚€è¯·ç é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </select>
                    <div id="invitationCodeError" class="error-message"></div>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                        å¦‚æœæ²¡æœ‰å¯ç”¨é‚€è¯·ç ï¼Œæ‚¨å¯ä»¥å…ˆè¯•ç”¨ï¼ˆé™18æ¬¡è®°å½•ï¼‰ã€‚
                    </div>
                </div>

                <div style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px;">
                    <button type="button" class="btn" id="fileImportBtn" style="font-size: 20px;">
                        ğŸ“ é€‰æ‹©æ–‡ä»¶å¯¼å…¥
                    </button>
                    <button type="button" class="btn btn-success" id="manualImportBtn" style="font-size: 20px;">
                        âœï¸ æ‰‹åŠ¨è¾“å…¥é‚€è¯·ç 
                    </button>
                    <button type="button" class="user-btn" id="refreshInviteListBtn" style="font-size: 20px;">
                        ğŸ”„ åˆ·æ–°åˆ—è¡¨
                    </button>
                </div>

                <!-- æ–‡ä»¶åˆ†äº«è¯´æ˜ -->
                <div
                    style="font-size: 11px; color: #666; margin-top: 12px; line-height: 1.4; padding: 8px; background-color: #f5f5f5; border-radius: 6px;">
                    <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>
                    1. ä»ç®¡ç†å‘˜å¤„è·å–é‚€è¯·ç æ–‡ä»¶ (.dat)<br>
                    2. ç‚¹å‡»"å¯¼å…¥æ–‡ä»¶"é€‰æ‹©æ–‡ä»¶<br>
                    3. ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"æŸ¥çœ‹å¯ç”¨é‚€è¯·ç <br>
                    4. é€‰æ‹©é‚€è¯·ç å®Œæˆæ³¨å†Œ
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-success" id="registerBtn">æ³¨å†Œ</button>
                <button class="btn btn-secondary" id="cancelRegisterBtn">å–æ¶ˆ</button>
            </div>
            <div class="modal-link">
                å·²æœ‰è´¦æˆ·ï¼Ÿ <a id="showLoginLink">ç«‹å³ç™»å½•</a>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>è¶³çƒè®©çƒ/å¤§å°ç›˜å£è®°å½•è½¯ä»¶</h1>
            <div class="subtitle">è®°å½•ã€åˆ†æã€æ¨èè¶³çƒè®©çƒç›˜å’Œå¤§å°ç›˜æ•°æ®</div>
            <div class="user-section">
                <div class="user-info" id="userInfo">
                    <!-- ç”¨æˆ·ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                </div>
                <div class="user-actions" id="userActions">
                    <!-- ç”¨æˆ·æ“ä½œæŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                </div>
            </div>
        </header>
        <div class="main-content">
            <!-- è¯•ç”¨æç¤ºä¿¡æ¯ -->
            <div id="trialInfo" class="trial-info" style="display: none;">
                æ‚¨æ˜¯è¯•ç”¨ç”¨æˆ·ï¼Œå‰©ä½™ä¿å­˜æ¬¡æ•°: <span id="trialCount" class="trial-count">18</span> æ¬¡
            </div>

            <!-- ç›˜å£ç±»å‹åˆ‡æ¢æ ‡ç­¾ -->
            <div class="handicap-tabs">
                <button class="handicap-tab active" data-tab="asian-handicap">è®©çƒç›˜</button>
                <button class="handicap-tab" data-tab="over-under">å¤§å°ç›˜</button>
            </div>

            <!-- è®©çƒç›˜å†…å®¹ -->
            <div id="asian-handicap-content" class="handicap-content active">
                <div class="input-section">
                    <h2 class="section-title">è®©çƒç›˜æ•°æ®å½•å…¥</h2>
                    <!-- æ–°å¢èµ›äº‹åç§°è¾“å…¥æ¡† -->
                    <div class="form-group">
                        <label for="asian-match-name">èµ›äº‹åç§°</label>
                        <input type="text" id="asian-match-name" placeholder="è¯·è¾“å…¥èµ›äº‹åç§°ï¼Œä¾‹å¦‚ï¼šæ›¼åŸ vs åˆ©ç‰©æµ¦">
                    </div>
                    <div class="form-group">
                        <label for="asian-initial-handicap">åˆå§‹ç›˜å£</label>
                        <select id="asian-initial-handicap">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- ç›˜å£ä»0åˆ°3ï¼Œé€’å¢åº¦ä¸º0.25 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="asian-current-handicap">å³æ—¶ç›˜å£</label>
                        <select id="asian-current-handicap">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- ç›˜å£ä»0åˆ°3ï¼Œé€’å¢åº¦ä¸º0.25 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="asian-initial-water">åˆå§‹æ°´ä½</label>
                        <select id="asian-initial-water">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- æ°´ä½ä»0.7åˆ°1.2ï¼Œé€’å¢åº¦ä¸º0.01 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="asian-current-water">å³æ—¶æ°´ä½</label>
                        <select id="asian-current-water">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- æ°´ä½ä»0.7åˆ°1.2ï¼Œé€’å¢åº¦ä¸º0.01 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="asian-historical-record">å†å²æˆ˜ç»©</label>
                        <select id="asian-historical-record">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="win">èµ¢</option>
                            <option value="loss">è¾“</option>
                        </select>
                    </div>
                    <div class="auto-calculation-note">æç¤ºï¼šé€‰æ‹©æ‰€æœ‰é€‰é¡¹ï¼Œä¿å­˜è®°å½•æ¨èç»“æœå°†è‡ªåŠ¨ç”Ÿæˆ</div>
                    <div class="button-group">
                        <button class="btn btn-success" id="save-asian-btn">ä¿å­˜è®©çƒç›˜è®°å½•</button>
                        <button class="btn btn-secondary" id="reset-asian-btn">é‡ç½®è¡¨å•</button>
                    </div>
                </div>
            </div>

            <!-- å¤§å°ç›˜å†…å®¹ -->
            <div id="over-under-content" class="handicap-content">
                <div class="input-section">
                    <h2 class="section-title">å¤§å°ç›˜æ•°æ®å½•å…¥</h2>
                    <!-- æ–°å¢èµ›äº‹åç§°è¾“å…¥æ¡† -->
                    <div class="form-group">
                        <label for="size-match-name">èµ›äº‹åç§°</label>
                        <input type="text" id="size-match-name" placeholder="è¯·è¾“å…¥èµ›äº‹åç§°ï¼Œä¾‹å¦‚ï¼šæ›¼åŸ vs åˆ©ç‰©æµ¦">
                    </div>
                    <div class="form-group">
                        <label for="size-initial-handicap">åˆå§‹å¤§å°ç›˜</label>
                        <select id="size-initial-handicap">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- å¤§å°ç›˜ä»1.5åˆ°4ï¼Œé€’å¢åº¦ä¸º0.25 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="size-current-handicap">å³æ—¶å¤§å°ç›˜</label>
                        <select id="size-current-handicap">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- å¤§å°ç›˜ä»1.5åˆ°4ï¼Œé€’å¢åº¦ä¸º0.25 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="size-initial-water">åˆå§‹æ°´ä½</label>
                        <select id="size-initial-water">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- æ°´ä½ä»0.7åˆ°1.2ï¼Œé€’å¢åº¦ä¸º0.01 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="size-current-water">å³æ—¶æ°´ä½</label>
                        <select id="size-current-water">
                            <option value="">è¯·é€‰æ‹©</option>
                            <!-- æ°´ä½ä»0.7åˆ°1.2ï¼Œé€’å¢åº¦ä¸º0.01 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="size-historical-record">å†å²æˆ˜ç»©</label>
                        <select id="size-historical-record">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="win">èµ¢</option>
                            <option value="loss">è¾“</option>
                        </select>
                    </div>
                    <div class="auto-calculation-note">æç¤ºï¼šé€‰æ‹©æ‰€æœ‰é€‰é¡¹ï¼Œä¿å­˜è®°å½•æ¨èç»“æœå°†è‡ªåŠ¨ç”Ÿæˆ</div>
                    <div class="button-group">
                        <button class="btn btn-success" id="save-size-btn">ä¿å­˜å¤§å°ç›˜è®°å½•</button>
                        <button class="btn btn-secondary" id="reset-size-btn">é‡ç½®è¡¨å•</button>
                    </div>
                </div>
            </div>

            <div class="result-section">
                <h2 class="section-title">æ¨èç»“æœä¸ç»Ÿè®¡</h2>
                <div class="dual-recommendation">
                    <div class="recommendation-box">
                        <div class="recommendation-label">è®©çƒç›˜æ¨è</div>
                        <div id="asian-recommendation-result" class="recommendation-result recommendation-neutral">
                            ç­‰å¾…è¾“å…¥ä¸­....</div>
                        <div id="asian-recommendation-details"
                            style="font-size: 13px; color: #666; margin-top: 8px; line-height: 1.4;"></div>
                    </div>
                    <div class="recommendation-box">
                        <div class="recommendation-label">å¤§å°ç›˜æ¨è</div>
                        <div id="size-recommendation-result"
                            class="recommendation-result size-recommendation-neutral">ç­‰å¾…è¾“å…¥ä¸­....</div>
                        <div id="size-recommendation-details"
                            style="font-size: 13px; color: #666; margin-top: 8px; line-height: 1.4;"></div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="stats-chart"></canvas>
                </div>
            </div>
            <div class="history-section">
                <div class="history-controls">
                    <h2 class="section-title">å†å²è®°å½•</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" id="toggle-history"
                            style="padding: 8px 12px; font-size: 13px;">éšè—è®°å½•</button>
                        <button class="btn btn-danger" id="clear-history"
                            style="padding: 8px 12px; font-size: 13px;">æ¸…ç©ºè®°å½•</button>
                    </div>
                </div>
                <div id="history-content">
                    <div class="history-table-container">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <!-- æ–°å¢èµ›äº‹åç§°åˆ— -->
                                    <th>èµ›äº‹åç§°</th>
                                    <th>ç›˜å£ç±»å‹</th>
                                    <th>ç›˜å£å˜åŒ–</th>
                                    <th>æ°´ä½å˜åŒ–</th>
                                    <th>å†å²æˆ˜ç»©</th>
                                    <th>æ¨èç»“æœ</th>
                                    <th>å®é™…ç»“æœ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <footer>
            <p>è¶³çƒè®©çƒ/å¤§å°ç›˜å£è®°å½•è½¯ä»¶ &copy; 2025 | æ•°æ®ä»…ä¾›å‚è€ƒï¼Œå¨±ä¹å°±è¡Œ</p>
        </footer>
    </div>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆåçš„é¢å¤–è°ƒè¯•
        window.addEventListener('load', function() {
            console.log('é¡µé¢å®Œå…¨åŠ è½½å®Œæˆ');

            // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å­˜åœ¨
            console.log('fileImportBtn å…ƒç´ :', document.getElementById('fileImportBtn'));
            console.log('manualImportBtn å…ƒç´ :', document.getElementById('manualImportBtn'));
            console.log('refreshInviteListBtn å…ƒç´ :', document.getElementById('refreshInviteListBtn'));

            // æ£€æŸ¥UserSystemæ–¹æ³•æ˜¯å¦å­˜åœ¨
            console.log('UserSystem.importViaFileInput:', typeof UserSystem.importViaFileInput);
            console.log('UserSystem.importManually:', typeof UserSystem.importManually);
            console.log('UserSystem.refreshInvitationCodeList:', typeof UserSystem.refreshInvitationCodeList);

            // æ·»åŠ ï¼šæ£€æŸ¥å¹¶æ¸…ç†è¿‡æœŸçš„é™åˆ¶
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
                StorageManager.isRestricted(currentUser.username); // è¿™ä¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„é™åˆ¶
            }

            // æ·»åŠ ï¼šä¸ºæ¸¸å®¢ä¹Ÿæ£€æŸ¥é™åˆ¶
            const guestRestriction = StorageManager.isRestricted('guest');
            if (guestRestriction.restricted) {
                console.warn('æ£€æµ‹åˆ°æ¸¸å®¢è´¦å·è¢«é™åˆ¶');
            }
        });
        // ============== å­˜å‚¨ç®¡ç†å™¨ï¼ˆé˜²æ­¢è¯•ç”¨æ¬¡æ•°é‡ç½®ï¼‰ ============== //

        const StorageManager = {
            // ä½¿ç”¨å¤šä¸ªå­˜å‚¨ä½ç½®
            setTrialData: function(username, data) {
                // æ·»åŠ åˆ›å»ºæ—¶é—´æˆ³ï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºï¼‰
                if (!data.createdTimestamp) {
                    data.createdTimestamp = Date.now();
                    data.firstUse = new Date().toISOString();
                }
                data.lastModified = Date.now();

                // å­˜å‚¨åˆ°å¤šä¸ªä½ç½®
                localStorage.setItem(`trial_${username}`, JSON.stringify(data));
                sessionStorage.setItem(`trial_${username}`, JSON.stringify(data));

                // é¢å¤–å­˜å‚¨ä¸€ä¸ªç‹¬ç«‹çš„æ—¶é—´æˆ³è®°å½•
                const timestampKey = `trial_timestamp_${username}`;
                const timestampData = {
                    firstCreated: data.createdTimestamp,
                    lastModified: Date.now(),
                    count: data.count || 0,
                    hash: this.generateHash(username, data)
                };

                localStorage.setItem(timestampKey, JSON.stringify(timestampData));

                // è®¾ç½®Cookieï¼ˆè¿‡æœŸæ—¶é—´30å¤©ï¼‰
                const expirationDays = 30;
                const date = new Date();
                date.setTime(date.getTime() + (expirationDays * 24 * 60 * 60 * 1000));
                const expires = "expires=" + date.toUTCString();
                const cookieData = btoa(JSON.stringify(timestampData));
                document.cookie = `trial_timestamp_${username}=${cookieData}; ${expires}; path=/; SameSite=Strict`;

                // å­˜å‚¨é¦–æ¬¡ä½¿ç”¨æ—¶é—´
                if (!localStorage.getItem(`trial_first_${username}`)) {
                    localStorage.setItem(`trial_first_${username}`, data.createdTimestamp.toString());
                    document.cookie = `trial_first_${username}=${data.createdTimestamp}; ${expires}; path=/`;
                }
            },

            getTrialData: function(username) {
                // å…ˆæ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦è¢«é‡ç½®
                const timestampKey = `trial_timestamp_${username}`;
                const timestampStr = localStorage.getItem(timestampKey);
                const cookieTimestamp = this.getCookie(`trial_timestamp_${username}`);

                let earliestTimestamp = null;
                let maxCount = 0;

                // éªŒè¯æ—¶é—´æˆ³ä¸€è‡´æ€§
                if (timestampStr || cookieTimestamp) {
                    try {
                        let localTimestamp = null;
                        let cookieData = null;

                        if (timestampStr) {
                            localTimestamp = JSON.parse(timestampStr);
                        }

                        if (cookieTimestamp) {
                            cookieData = JSON.parse(atob(cookieTimestamp));
                        }

                        // æ‰¾å‡ºæœ€æ—©çš„åˆ›å»ºæ—¶é—´
                        if (localTimestamp && cookieData) {
                            earliestTimestamp = Math.min(localTimestamp.firstCreated, cookieData.firstCreated);
                            maxCount = Math.max(localTimestamp.count || 0, cookieData.count || 0);

                            // æ£€æµ‹æ—¶é—´æˆ³å¼‚å¸¸
                            const timeDiff = Math.abs(localTimestamp.firstCreated - cookieData.firstCreated);
                            if (timeDiff > 24 * 60 * 60 * 1000) { // è¶…è¿‡1å¤©çš„å·®å¼‚
                                console.warn('æ£€æµ‹åˆ°æ—¶é—´æˆ³å¼‚å¸¸ï¼Œç”¨æˆ·å¯èƒ½è¯•å›¾é‡ç½®æ•°æ®');
                                // è®°å½•å¯ç–‘è¡Œä¸º
                                this.recordSuspiciousActivity(username);
                            }
                        } else if (localTimestamp) {
                            earliestTimestamp = localTimestamp.firstCreated;
                            maxCount = localTimestamp.count || 0;
                        } else if (cookieData) {
                            earliestTimestamp = cookieData.firstCreated;
                            maxCount = cookieData.count || 0;
                        }
                    } catch (e) {
                        console.error('æ—¶é—´æˆ³éªŒè¯å¤±è´¥:', e);
                    }
                }

                // ç„¶åä»å¤šä¸ªå­˜å‚¨ä½ç½®è·å–æ•°æ®
                const sources = [];

                // 1. ä» localStorage è·å–
                const localStorageData = localStorage.getItem(`trial_${username}`);
                if (localStorageData) {
                    try {
                        const parsedData = JSON.parse(localStorageData);
                        // å¦‚æœæ£€æµ‹åˆ°æ—¶é—´æˆ³è¢«é‡ç½®ï¼Œä¿®æ­£æ•°æ®
                        if (earliestTimestamp && parsedData.createdTimestamp &&
                            parsedData.createdTimestamp > earliestTimestamp + 1000) {
                            console.warn('æ£€æµ‹åˆ°åˆ›å»ºæ—¶é—´æˆ³è¢«ä¿®æ”¹ï¼Œæ­£åœ¨ä¿®æ­£');
                            parsedData.createdTimestamp = earliestTimestamp;
                            parsedData.count = Math.max(parsedData.count || 0, maxCount);
                        }
                        sources.push({
                            source: 'localStorage',
                            data: parsedData
                        });
                    } catch (e) {
                        console.error('localStorage æ•°æ®è§£æå¤±è´¥:', e);
                    }
                }

                // 2. ä» sessionStorage è·å–
                const sessionStorageData = sessionStorage.getItem(`trial_${username}`);
                if (sessionStorageData) {
                    try {
                        const parsedData = JSON.parse(sessionStorageData);
                        sources.push({
                            source: 'sessionStorage',
                            data: parsedData
                        });
                    } catch (e) {
                        console.error('sessionStorage æ•°æ®è§£æå¤±è´¥:', e);
                    }
                }

                // 3. ä» Cookie è·å–
                const cookieData = this.getCookie(`trial_${username}`);
                if (cookieData) {
                    try {
                        const decodedData = atob(cookieData);
                        const parsedData = JSON.parse(decodedData);
                        sources.push({
                            source: 'cookie',
                            data: parsedData
                        });
                    } catch (e) {
                        console.error('Cookie æ•°æ®è§£æå¤±è´¥:', e);
                    }
                }

                // é€‰æ‹©æœ€å¯ä¿¡çš„æ•°æ®æº
                if (sources.length > 0) {
                    const priorityOrder = ['localStorage', 'sessionStorage', 'cookie'];

                    for (const sourceName of priorityOrder) {
                        const source = sources.find(s => s.source === sourceName);
                        if (source) {
                            // éªŒè¯æ•°æ®å®Œæ•´æ€§
                            if (this.verifyDataIntegrity(username, source.data)) {
                                // ç¡®ä¿ä½¿ç”¨æœ€æ—©çš„æ—¶é—´æˆ³
                                if (earliestTimestamp && source.data.createdTimestamp > earliestTimestamp) {
                                    source.data.createdTimestamp = earliestTimestamp;
                                }
                                return source.data;
                            }
                        }
                    }

                    // å¦‚æœéƒ½æ²¡æœ‰é€šè¿‡éªŒè¯ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæº
                    return sources[0].data;
                }

                return null;
            },

            // ç”Ÿæˆæ•°æ®å“ˆå¸Œ
            generateHash: function(username, data) {
                const timestamp = new Date().getTime();
                const str = `${username}_${JSON.stringify(data)}_${timestamp}_${Math.random()}`;
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(16);
            },

            // éªŒè¯æ•°æ®å®Œæ•´æ€§
            verifyDataIntegrity: function(username, data) {
                const storedHash = localStorage.getItem(`trial_hash_${username}`);
                if (!storedHash) return true; // å¦‚æœæ²¡æœ‰å­˜å‚¨å“ˆå¸Œï¼Œå¯èƒ½æ˜¯é¦–æ¬¡ä½¿ç”¨

                const currentHash = this.generateHash(username, data);
                return storedHash === currentHash;
            },

            // Cookie æ“ä½œæ–¹æ³•
            getCookie: function(name) {
                const nameEQ = name + "=";
                const ca = document.cookie.split(';');
                for (let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === ' ') {
                        c = c.substring(1);
                    }
                    if (c.indexOf(nameEQ) === 0) {
                        return c.substring(nameEQ.length, c.length);
                    }
                }
                return null;
            },

            // æ¸…ç†æ‰€æœ‰å­˜å‚¨çš„æ–¹æ³•ï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰
            clearAllStorages: function(username) {
                console.warn('æ¸…ç†æ‰€æœ‰å­˜å‚¨ï¼Œä»…ä¾›è°ƒè¯•ä½¿ç”¨');

                // æ¸…ç† localStorage
                localStorage.removeItem(`trial_${username}`);
                localStorage.removeItem(`trial_hash_${username}`);
                localStorage.removeItem(`trial_timestamp_${username}`);
                localStorage.removeItem(`trial_first_${username}`);
                localStorage.removeItem(`trial_suspicious_${username}`);
                localStorage.removeItem(`trial_restriction_${username}`);

                // æ¸…ç† sessionStorage
                sessionStorage.removeItem(`trial_${username}`);

                // æ¸…ç† cookie
                document.cookie = `trial_${username}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                document.cookie = `trial_timestamp_${username}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                document.cookie = `trial_first_${username}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                document.cookie = `trial_restriction_${username}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
            },

            // è¿ç§»æ—§æ•°æ®åˆ°æ–°ç³»ç»Ÿ
            migrateOldData: function() {
                // è¿ç§»æ—§çš„ trialRecords æ•°æ®åˆ°æ–°ç³»ç»Ÿ
                const oldTrialRecords = JSON.parse(localStorage.getItem('trialRecords') || '{}');

                for (const username in oldTrialRecords) {
                    if (oldTrialRecords.hasOwnProperty(username)) {
                        const oldCount = oldTrialRecords[username];

                        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ–°æ ¼å¼çš„æ•°æ®
                        let trialData = this.getTrialData(username);

                        // å¦‚æœæ²¡æœ‰æ–°æ•°æ®ï¼Œæˆ–è€…æ—§æ•°æ®æ›´å¤§ï¼Œä½¿ç”¨æ—§æ•°æ®
                        if (!trialData || trialData.count < oldCount) {
                            const newData = {
                                count: oldCount,
                                createdTimestamp: Date.now(),
                                firstUse: new Date().toISOString(),
                                lastUpdate: new Date().toISOString(),
                                attempts: oldCount,
                                migratedFromOld: true
                            };

                            this.setTrialData(username, newData);
                            console.log(`å·²è¿ç§»ç”¨æˆ· ${username} çš„è¯•ç”¨æ•°æ®: ${oldCount} æ¬¡`);
                        }
                    }
                }

                // å¯é€‰ï¼šæ¸…ç†æ—§æ•°æ®
                // localStorage.removeItem('trialRecords');
            },

            // æ–°å¢ï¼šéªŒè¯è¯•ç”¨æœŸæ˜¯å¦è¿‡æœŸ
            isTrialExpired: function(username) {
                const trialData = this.getTrialData(username);
                if (!trialData || !trialData.createdTimestamp) {
                    return false; // æ— æ•°æ®ï¼Œè§†ä¸ºæ–°ç”¨æˆ·
                }

                const TRIAL_PERIOD_DAYS = 7; // 7å¤©è¯•ç”¨æœŸ
                const TRIAL_PERIOD_MS = TRIAL_PERIOD_DAYS * 24 * 60 * 60 * 1000;
                const now = Date.now();
                const trialAge = now - trialData.createdTimestamp;

                // å¦‚æœè¶…è¿‡è¯•ç”¨æœŸï¼Œè¿”å›true
                return trialAge > TRIAL_PERIOD_MS;
            },

            // æ–°å¢ï¼šè·å–å‰©ä½™çš„è¯•ç”¨å¤©æ•°
            getRemainingTrialDays: function(username) {
                const trialData = this.getTrialData(username);
                if (!trialData || !trialData.createdTimestamp) {
                    return 7; // è¿”å›å®Œæ•´è¯•ç”¨æœŸ
                }

                const TRIAL_PERIOD_DAYS = 7;
                const TRIAL_PERIOD_MS = TRIAL_PERIOD_DAYS * 24 * 60 * 60 * 1000;
                const now = Date.now();
                const trialAge = now - trialData.createdTimestamp;
                const remainingMs = TRIAL_PERIOD_MS - trialAge;

                if (remainingMs <= 0) return 0;

                return Math.ceil(remainingMs / (24 * 60 * 60 * 1000));
            },

            // æ–°å¢ï¼šè®°å½•å¯ç–‘è¡Œä¸º
            recordSuspiciousActivity: function(username) {
                const activityKey = `trial_suspicious_${username}`;
                const now = Date.now();
                const ONE_DAY_MS = 24 * 60 * 60 * 1000;

                let activities = JSON.parse(localStorage.getItem(activityKey) || '[]');
                activities.push({
                    timestamp: now,
                    type: 'timestamp_mismatch'
                });

                // åªä¿ç•™æœ€è¿‘7å¤©çš„è®°å½•
                activities = activities.filter(activity => now - activity.timestamp < 7 * ONE_DAY_MS);

                localStorage.setItem(activityKey, JSON.stringify(activities));

                // å¦‚æœ24å°æ—¶å†…è¶…è¿‡2æ¬¡å¯ç–‘æ´»åŠ¨ï¼Œè¿›è¡Œé™åˆ¶
                const recentActivities = activities.filter(activity => now - activity.timestamp < ONE_DAY_MS);
                if (recentActivities.length > 2) {
                    console.warn(`ç”¨æˆ· ${username} è¢«æ£€æµ‹åˆ°å¤šæ¬¡å¯ç–‘æ´»åŠ¨ï¼Œåº”ç”¨é™åˆ¶`);
                    this.applyRestrictions(username);
                }
            },

            // æ–°å¢ï¼šåº”ç”¨ä½¿ç”¨é™åˆ¶
            applyRestrictions: function(username) {
                const restrictionKey = `trial_restriction_${username}`;
                const restriction = {
                    restrictedUntil: Date.now() + (48 * 60 * 60 * 1000), // é™åˆ¶48å°æ—¶
                    reason: 'å¤šæ¬¡æ•°æ®å¼‚å¸¸',
                    appliedAt: Date.now()
                };

                localStorage.setItem(restrictionKey, JSON.stringify(restriction));

                // è®¾ç½®Cookieé™åˆ¶
                const date = new Date();
                date.setTime(date.getTime() + (48 * 60 * 60 * 1000));
                const expires = "expires=" + date.toUTCString();
                document.cookie = `${restrictionKey}=${btoa(JSON.stringify(restriction))}; ${expires}; path=/`;

                return restriction;
            },

            // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦è¢«é™åˆ¶
            isRestricted: function(username) {
                const restrictionKey = `trial_restriction_${username}`;
                const restrictionStr = localStorage.getItem(restrictionKey);

                if (restrictionStr) {
                    try {
                        const restriction = JSON.parse(restrictionStr);
                        if (Date.now() < restriction.restrictedUntil) {
                            const hoursLeft = Math.ceil((restriction.restrictedUntil - Date.now()) / (60 * 60 *
                                1000));
                            console.warn(`ç”¨æˆ· ${username} è¢«é™åˆ¶ä½¿ç”¨ï¼Œå‰©ä½™ ${hoursLeft} å°æ—¶`);
                            return {
                                restricted: true,
                                reason: restriction.reason,
                                hoursLeft: hoursLeft
                            };
                        } else {
                            // é™åˆ¶å·²è¿‡æœŸï¼Œæ¸…ç†
                            localStorage.removeItem(restrictionKey);
                            document.cookie = `${restrictionKey}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                        }
                    } catch (e) {
                        console.error('è§£æé™åˆ¶æ•°æ®å¤±è´¥:', e);
                    }
                }

                return {
                    restricted: false
                };
            }
        };

        // ============== æµè§ˆå™¨æŒ‡çº¹ç®¡ç†å™¨ ============== //
        const FingerprintManager = {
            // ç”Ÿæˆå¿«é€ŸåŸºç¡€æŒ‡çº¹ï¼ˆç«‹å³æ‰§è¡Œï¼‰
            generateQuickFingerprint: function() {
                const components = [
                    navigator.userAgent,
                    navigator.language,
                    screen.width + 'x' + screen.height,
                    screen.colorDepth,
                    new Date().getTimezoneOffset(),
                    !!window.sessionStorage,
                    !!window.localStorage
                ];

                let hash = 0;
                const str = components.join('|');
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }

                const fingerprint = 'fp_' + Math.abs(hash).toString(36).substring(0, 12);

                // å­˜å‚¨åˆ°sessionStorage
                sessionStorage.setItem('quick_fingerprint', fingerprint);

                console.log('å¿«é€ŸæŒ‡çº¹å·²ç”Ÿæˆ:', fingerprint);

                return fingerprint;
            },

            // ç”Ÿæˆè¯¦ç»†æŒ‡çº¹ï¼ˆéœ€è¦Canvasï¼‰
            generateDetailedFingerprint: function() {
                try {
                    // CanvasæŒ‡çº¹
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // ç»˜åˆ¶ä¸€äº›å†…å®¹
                    ctx.textBaseline = "top";
                    ctx.font = "14px 'Arial'";
                    ctx.fillStyle = "#f60";
                    ctx.fillRect(125, 1, 62, 20);
                    ctx.fillStyle = "#069";
                    ctx.fillText("FP@1.0", 2, 15);
                    ctx.fillStyle = "rgba(102, 204, 0, 0.7)";
                    ctx.fillText("FP@1.0", 4, 17);

                    const canvasFingerprint = canvas.toDataURL();

                    // ç»“åˆå…¶ä»–ä¿¡æ¯
                    const components = [
                        navigator.userAgent,
                        navigator.language,
                        navigator.platform,
                        screen.width + 'x' + screen.height,
                        screen.colorDepth,
                        new Date().getTimezoneOffset(),
                        canvasFingerprint.substring(0, 100) // å–å‰100ä¸ªå­—ç¬¦
                    ];

                    let hash = 0;
                    const str = components.join('||');
                    for (let i = 0; i < str.length; i++) {
                        const char = str.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }

                    const fingerprint = Math.abs(hash).toString(16).padStart(8, '0');

                    // å­˜å‚¨åˆ°å¤šä¸ªä½ç½®
                    sessionStorage.setItem('detailed_fingerprint', fingerprint);
                    localStorage.setItem('last_fingerprint', fingerprint);

                    console.log('è¯¦ç»†æŒ‡çº¹å·²ç”Ÿæˆ:', fingerprint);
                    return fingerprint;

                } catch (error) {
                    console.warn('è¯¦ç»†æŒ‡çº¹ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨å¿«é€ŸæŒ‡çº¹:', error);
                    return this.generateQuickFingerprint();
                }
            },

            // åˆå§‹åŒ–æŒ‡çº¹ç³»ç»Ÿ
            init: function() {
                console.log('åˆå§‹åŒ–æŒ‡çº¹ç³»ç»Ÿ...');

                // 1. ç«‹å³ç”Ÿæˆå¿«é€ŸæŒ‡çº¹
                const quickFp = this.generateQuickFingerprint();

                // 2. å»¶è¿Ÿç”Ÿæˆè¯¦ç»†æŒ‡çº¹ï¼ˆé¿å…é˜»å¡é¡µé¢åŠ è½½ï¼‰
                setTimeout(() => {
                    this.generateDetailedFingerprint();

                }, 1000);

                // 3. æ£€æŸ¥å·²æœ‰æŒ‡çº¹
                this.checkExistingFingerprint();

                return quickFp;
            },

            // æ£€æŸ¥ç°æœ‰æŒ‡çº¹
            checkExistingFingerprint: function() {
                const existingFp = localStorage.getItem('last_fingerprint');
                const currentQuickFp = sessionStorage.getItem('quick_fingerprint');

                if (existingFp) {
                    console.log('å‘ç°å·²æœ‰æŒ‡çº¹è®°å½•:', existingFp.substring(0, 8) + '...');

                    // è¿™é‡Œå¯ä»¥æ·»åŠ æŒ‡çº¹éªŒè¯é€»è¾‘
                    // å¦‚æœå‘ç°æŒ‡çº¹ä¸ä¸€è‡´ï¼Œå¯èƒ½ç”¨æˆ·æ¸…é™¤äº†æ•°æ®
                }

                // å­˜å‚¨æŒ‡çº¹ç”Ÿæˆæ—¶é—´
                localStorage.setItem('fingerprint_init_time', Date.now().toString());
            },

            // è·å–å½“å‰æŒ‡çº¹
            getCurrentFingerprint: function() {
                const detailedFp = sessionStorage.getItem('detailed_fingerprint');
                const quickFp = sessionStorage.getItem('quick_fingerprint');

                return detailedFp || quickFp || 'unknown';
            },

            // éªŒè¯æŒ‡çº¹ä¸€è‡´æ€§ï¼ˆç”¨äºé˜²æ¸…é™¤ï¼‰
            verifyConsistency: function(username) {
                const storedKey = `fp_${username}`;
                const storedFingerprint = localStorage.getItem(storedKey);
                const currentFingerprint = this.getCurrentFingerprint();

                if (storedFingerprint && storedFingerprint !== currentFingerprint) {
                    console.warn(`ç”¨æˆ· ${username} æŒ‡çº¹ä¸ä¸€è‡´ï¼`);
                    console.warn('å­˜å‚¨çš„:', storedFingerprint);
                    console.warn('å½“å‰çš„:', currentFingerprint);

                    // è®°å½•å¯ç–‘æ´»åŠ¨
                    this.recordSuspiciousActivity(username, 'fingerprint_mismatch');
                    return false;
                }

                return true;
            },

            // è®°å½•å¯ç–‘æ´»åŠ¨
            recordSuspiciousActivity: function(username, type) {
                const activityKey = `fp_activity_${username}`;
                const now = Date.now();

                let activities = JSON.parse(localStorage.getItem(activityKey) || '[]');
                activities.push({
                    timestamp: now,
                    type: type,
                    fingerprint: this.getCurrentFingerprint()
                });

                // åªä¿ç•™æœ€è¿‘10æ¡è®°å½•
                if (activities.length > 10) {
                    activities = activities.slice(-10);
                }

                localStorage.setItem(activityKey, JSON.stringify(activities));

                // æ£€æŸ¥æ˜¯å¦é¢‘ç¹å˜æ›´
                const oneDayAgo = now - (24 * 60 * 60 * 1000);
                const recentActivities = activities.filter(a => a.timestamp > oneDayAgo);

                if (recentActivities.length > 3) {
                    console.warn(`ç”¨æˆ· ${username} 24å°æ—¶å†…æŒ‡çº¹å˜æ›´è¶…è¿‡3æ¬¡`);
                    return false;
                }

                return true;
            },

            // å­˜å‚¨ç”¨æˆ·å…³è”æŒ‡çº¹
            storeUserFingerprint: function(username) {
                const fingerprint = this.getCurrentFingerprint();
                const storageKey = `fp_${username}`;

                localStorage.setItem(storageKey, fingerprint);

                // åŒæ—¶å­˜å‚¨æ—¶é—´æˆ³
                const timestampKey = `fp_time_${username}`;
                localStorage.setItem(timestampKey, Date.now().toString());

                console.log(`ä¸ºç”¨æˆ· ${username} å­˜å‚¨æŒ‡çº¹: ${fingerprint}`);
                return fingerprint;
            }
        };
        // ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
        const UserSystem = {
            // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
            init: function() {
                console.log('å¼€å§‹åˆå§‹åŒ–ç”¨æˆ·ç³»ç»Ÿ...');

                // ========== ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–æŒ‡çº¹ç³»ç»Ÿ ========== //
                FingerprintManager.init();

                // ========== ç¬¬äºŒæ­¥ï¼šè¿ç§»æ—§æ•°æ® ========== //
                StorageManager.migrateOldData();

                // ========== ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ–é‚€è¯·ç  ========== //
                if (!localStorage.getItem('invitationCodes')) {
                    localStorage.setItem('invitationCodes', JSON.stringify([]));
                }

                // ========== ç¬¬å››æ­¥ï¼šåˆå§‹åŒ–é»˜è®¤ç”¨æˆ· ========== //
                if (!localStorage.getItem('users')) {
                    const defaultUsers = [{
                        id: 1,
                        username: 'admin',
                        password: 'admin123',
                        userType: 'admin',
                        registrationDate: new Date().toISOString(),
                        lastLogin: new Date().toISOString()
                    }];
                    localStorage.setItem('users', JSON.stringify(defaultUsers));
                }

                // ========== ç¬¬äº”æ­¥ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€ ========== //
                this.checkLoginStatus();

                console.log('ç”¨æˆ·ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');

                // æ–°å¢ï¼šæ¸…ç†æ‰€æœ‰ç”¨æˆ·çš„è¿‡æœŸé™åˆ¶
                this.cleanupExpiredRestrictions();
            },

            // æ–°å¢ï¼šæ¸…ç†è¿‡æœŸé™åˆ¶
            cleanupExpiredRestrictions: function() {
                // è·å–æ‰€æœ‰å­˜å‚¨çš„é”®
                const keys = Object.keys(localStorage);
                const restrictionKeys = keys.filter(key => key.startsWith('trial_restriction_'));

                restrictionKeys.forEach(key => {
                    try {
                        const restriction = JSON.parse(localStorage.getItem(key));
                        if (restriction && restriction.restrictedUntil) {
                            if (Date.now() > restriction.restrictedUntil) {
                                localStorage.removeItem(key);
                                console.log('æ¸…ç†è¿‡æœŸé™åˆ¶:', key);
                            }
                        }
                    } catch (e) {
                        console.error('æ¸…ç†é™åˆ¶æ—¶å‡ºé”™:', e);
                    }
                });
            },

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkLoginStatus: function() {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                if (currentUser) {
                    // ========== æ–°å¢ï¼šéªŒè¯æŒ‡çº¹ ========== //
                    const fingerprintValid = FingerprintManager.verifyConsistency(currentUser.username);
                    if (!fingerprintValid) {
                        console.warn(`ç”¨æˆ· ${currentUser.username} æŒ‡çº¹éªŒè¯å¤±è´¥`);
                        // å¯ä»¥æ˜¾ç¤ºè­¦å‘Šï¼Œä½†ä¸å¼ºåˆ¶é€€å‡º
                    }
                    // æ£€æŸ¥å¹¶æ¸…ç†è¿‡æœŸçš„é™åˆ¶
                    StorageManager.isRestricted(currentUser.username); // è¿™ä¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„é™åˆ¶
                    this.updateUI(currentUser);

                    // æ›´æ–°è¯•ç”¨ä¿¡æ¯æ˜¾ç¤º
                    if (currentUser.userType === 'trial') {
                        this.updateTrialInfo(currentUser.username);
                    }
                } else {
                    this.showGuestUI();
                }
            },

            // æ˜¾ç¤ºæ¸¸å®¢UI
            showGuestUI: function() {
                document.getElementById('userInfo').innerHTML = `
            <div class="user-name">æ¸¸å®¢</div>
            <div class="user-type">è¯•ç”¨ç”¨æˆ·</div>
        `;
                document.getElementById('userActions').innerHTML = `
            <button class="user-btn" id="loginBtnHeader">ç™»å½•</button>
            <button class="user-btn" id="registerBtnHeader">æ³¨å†Œ</button>
        `;

                // æ˜¾ç¤ºè¯•ç”¨ä¿¡æ¯
                const trialInfoElement = document.getElementById('trialInfo');
                if (trialInfoElement) {
                    trialInfoElement.style.display = 'block';
                    this.updateTrialInfo('guest');
                }

                // ç»‘å®šäº‹ä»¶
                document.getElementById('loginBtnHeader').addEventListener('click', () => this.showLoginModal());
                document.getElementById('registerBtnHeader').addEventListener('click', () => this
                .showRegisterModal());
            },

            // æ›´æ–°ç”¨æˆ·UI
            updateUI: function(user) {
                document.getElementById('userInfo').innerHTML = `
            <div class="user-name">${user.username}</div>
            <div class="user-type">${user.userType === 'admin' ? 'ç®¡ç†å‘˜' : (user.userType === 'registered' ? 'æ³¨å†Œä¼šå‘˜' : 'è¯•ç”¨ç”¨æˆ·')}</div>
        `;

                let actionsHTML = '';
                if (user.userType === 'admin') {
                    actionsHTML = `<button class="user-btn" id="logoutBtn">é€€å‡º</button>`;
                } else {
                    actionsHTML = `
                <button class="user-btn" id="logoutBtn">é€€å‡º</button>
            `;
                }
                document.getElementById('userActions').innerHTML = actionsHTML;

                // æ˜¾ç¤ºæˆ–éšè—è¯•ç”¨ä¿¡æ¯
                const trialInfoElement = document.getElementById('trialInfo');
                if (trialInfoElement) {
                    if (user.userType === 'trial') {
                        trialInfoElement.style.display = 'block';
                    } else {
                        trialInfoElement.style.display = 'none';
                    }
                }

                // ç»‘å®šé€€å‡ºäº‹ä»¶
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
            },

            // æ›´æ–°è¯•ç”¨ä¿¡æ¯
            updateTrialInfo: function(username) {
                const trialData = StorageManager.getTrialData(username);
                const usedCount = trialData ? trialData.count : 0;
                const remaining = 18 - usedCount;

                // æ£€æŸ¥è¯•ç”¨æœŸ
                const isExpired = StorageManager.isTrialExpired(username);
                const remainingDays = StorageManager.getRemainingTrialDays(username);

                // æ£€æŸ¥æ˜¯å¦è¢«é™åˆ¶
                const restriction = StorageManager.isRestricted(username);

                const trialCountElement = document.getElementById('trialCount');
                if (trialCountElement) {
                    trialCountElement.textContent = remaining;
                }

                // æ·»åŠ æ—¶é—´ä¿¡æ¯å’Œè¯•ç”¨æœŸä¿¡æ¯æ˜¾ç¤º
                const trialInfoElement = document.getElementById('trialInfo');
                if (trialInfoElement && trialData && trialData.firstUse) {
                    const firstUseDate = new Date(trialData.firstUse);
                    const formattedDate = firstUseDate.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });

                    let infoHtml = `æ‚¨æ˜¯è¯•ç”¨ç”¨æˆ·ï¼Œå‰©ä½™ä¿å­˜æ¬¡æ•°: <span class="trial-count">${remaining}</span> æ¬¡`;

                    // æ·»åŠ è¯•ç”¨æœŸä¿¡æ¯
                    if (isExpired) {
                        infoHtml += `<div style="font-size: 11px; margin-top: 4px; color: #dc3545;">
                      âš ï¸ è¯•ç”¨æœŸå·²è¿‡æœŸ
                  </div>`;
                    } else if (remainingDays < 7) {
                        infoHtml += `<div style="font-size: 11px; margin-top: 4px; color: #ff9800;">
                      â³ è¯•ç”¨æœŸå‰©ä½™: ${remainingDays} å¤©
                  </div>`;
                    }

                    // æ·»åŠ é™åˆ¶ä¿¡æ¯
                    if (restriction.restricted) {
                        infoHtml += `<div style="font-size: 11px; margin-top: 4px; color: #dc3545;">
                      ğŸš« è´¦å·å—é™: ${restriction.reason} (å‰©ä½™ ${restriction.hoursLeft} å°æ—¶)
                  </div>`;
                    } else {
                        infoHtml += `<div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">
                      é¦–æ¬¡ä½¿ç”¨: ${formattedDate} | å·²ä½¿ç”¨: ${usedCount}æ¬¡
                  </div>`;
                    }

                    trialInfoElement.innerHTML = infoHtml;
                }
            },

            // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
            showLoginModal: function() {
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('loginUsername').focus();
            },

            // æ˜¾ç¤ºæ³¨å†Œæ¨¡æ€æ¡†
            showRegisterModal: function() {
                document.getElementById('registerModal').style.display = 'flex';
                document.getElementById('registerUsername').focus();

                // æ¸…é™¤æ‰€æœ‰é”™è¯¯æ¶ˆæ¯
                this.clearAllErrors();

                // åˆ·æ–°é‚€è¯·ç åˆ—è¡¨

                this.refreshInvitationCodeList();

            },

            // éšè—æ‰€æœ‰æ¨¡æ€æ¡†
            hideAllModals: function() {
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('registerModal').style.display = 'none';
            },

            login: function() {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value.trim();

                // éªŒè¯è¾“å…¥
                let isValid = true;
                if (!username) {
                    this.showError('loginUsernameError', 'è¯·è¾“å…¥ç”¨æˆ·å');
                    isValid = false;
                } else {
                    this.hideError('loginUsernameError');
                }

                if (!password) {
                    this.showError('loginPasswordError', 'è¯·è¾“å…¥å¯†ç ');
                    isValid = false;
                } else {
                    this.hideError('loginPasswordError');
                }

                if (!isValid) return;

                // è·å–ç”¨æˆ·æ•°æ®
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const user = users.find(u => u.username === username && u.password === password);

                if (user) {
                    // ========== æ–°å¢ï¼šéªŒè¯æŒ‡çº¹ä¸€è‡´æ€§ ========== //
                    const fingerprintValid = FingerprintManager.verifyConsistency(username);
                    if (!fingerprintValid) {
                        alert('æ£€æµ‹åˆ°æµè§ˆå™¨ç¯å¢ƒå¼‚å¸¸ï¼Œè¯·å‹¿é¢‘ç¹æ¸…é™¤æ•°æ®ï¼');
                    }

                    // ========== æ–°å¢ï¼šå­˜å‚¨ç”¨æˆ·æŒ‡çº¹å…³è” ========== //
                    FingerprintManager.storeUserFingerprint(username);

                    // æ›´æ–°æœ€åç™»å½•æ—¶é—´
                    user.lastLogin = new Date().toISOString();
                    localStorage.setItem('users', JSON.stringify(users));

                    // ä¿å­˜å½“å‰ç”¨æˆ·
                    localStorage.setItem('currentUser', JSON.stringify(user));

                    // æ›´æ–°UI
                    this.updateUI(user);

                    // éšè—æ¨¡æ€æ¡†
                    this.hideAllModals();

                    // æ›´æ–°è¯•ç”¨ä¿¡æ¯
                    if (user.userType === 'trial') {
                        this.updateTrialInfo(user.username);
                    }

                    // é‡æ–°åŠ è½½å†å²è®°å½•
                    loadHistory();

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    alert(`æ¬¢è¿å›æ¥ï¼Œ${user.username}ï¼`);
                } else {
                    this.showError('loginPasswordError', 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                }
            },

            // æ³¨å†Œ
            register: function() {
                const username = document.getElementById('registerUsername').value.trim();
                const password = document.getElementById('registerPassword').value.trim();
                const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
                const invitationCode = document.getElementById('invitationCode').value.trim();

                // éªŒè¯è¾“å…¥
                let isValid = true;
                if (!username || username.length < 3) {
                    this.showError('registerUsernameError', 'ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦');
                    isValid = false;
                } else {
                    this.hideError('registerUsernameError');
                }

                if (!password || password.length < 6) {
                    this.showError('registerPasswordError', 'å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦');
                    isValid = false;
                } else {
                    this.hideError('registerPasswordError');
                }

                if (password !== confirmPassword) {
                    this.showError('registerConfirmPasswordError', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                    isValid = false;
                } else {
                    this.hideError('registerConfirmPasswordError');
                }

                if (!invitationCode) {
                    this.showError('invitationCodeError', 'è¯·é€‰æ‹©é‚€è¯·ç ');
                    isValid = false;
                } else {
                    this.hideError('invitationCodeError');
                }

                if (!isValid) return;

                // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                if (users.find(u => u.username === username)) {
                    this.showError('registerUsernameError', 'ç”¨æˆ·åå·²å­˜åœ¨');
                    return;
                }

                // éªŒè¯é‚€è¯·ç 
                const invitationCodes = JSON.parse(localStorage.getItem('invitationCodes') || '[]');
                const validCode = invitationCodes.find(code => code.code === invitationCode && !code.used);

                let userType = 'trial'; // é»˜è®¤ä¸ºè¯•ç”¨ç”¨æˆ·
                if (validCode) {
                    userType = 'registered'; // æ³¨å†Œä¼šå‘˜
                    // æ ‡è®°é‚€è¯·ç ä¸ºå·²ä½¿ç”¨
                    validCode.used = true;
                    validCode.usedBy = username;
                    validCode.usedDate = new Date().toISOString();
                    localStorage.setItem('invitationCodes', JSON.stringify(invitationCodes));
                } else {
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ•ˆçš„é‚€è¯·ç ä½†å·²è¢«ä½¿ç”¨
                    const usedCode = invitationCodes.find(code => code.code === invitationCode && code.used);
                    if (usedCode) {
                        this.showError('invitationCodeError', 'è¯¥é‚€è¯·ç å·²è¢«ä½¿ç”¨');
                        return;
                    } else {
                        this.showError('invitationCodeError', 'æ— æ•ˆçš„é‚€è¯·ç ');
                        return;
                    }
                }

                // åˆ›å»ºæ–°ç”¨æˆ·
                const newUser = {
                    id: Date.now(),
                    username,
                    password,
                    userType,
                    registrationDate: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                };

                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));

                // ä¿å­˜å½“å‰ç”¨æˆ·
                localStorage.setItem('currentUser', JSON.stringify(newUser));

                // ========== æ–°å¢ï¼šå­˜å‚¨ç”¨æˆ·æŒ‡çº¹å…³è” ========== //
                FingerprintManager.storeUserFingerprint(username);

                // æ›´æ–°UI
                this.updateUI(newUser);

                // éšè—æ¨¡æ€æ¡†
                this.hideAllModals();

                // é‡æ–°åŠ è½½å†å²è®°å½•
                loadHistory();

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert(`æ³¨å†ŒæˆåŠŸï¼æ¬¢è¿${userType === 'registered' ? 'æ³¨å†Œä¼šå‘˜' : 'è¯•ç”¨ç”¨æˆ·'}${username}`);
            },

            // é€€å‡ºç™»å½•
            logout: function() {
                localStorage.removeItem('currentUser');
                this.showGuestUI();
                // é‡æ–°åŠ è½½å†å²è®°å½•
                loadHistory();
                alert('å·²é€€å‡ºç™»å½•');
            },

            // æ£€æŸ¥è¯•ç”¨ç”¨æˆ·æ˜¯å¦å¯ä»¥ä¿å­˜è®°å½•
            canSaveRecord: function(username) {
                // ========== æ–°å¢ï¼šæ£€æŸ¥æŒ‡çº¹å¼‚å¸¸ ========== //
                const fingerprintValid = FingerprintManager.verifyConsistency(username);
                if (!fingerprintValid) {
                    console.warn(`ç”¨æˆ· ${username} æŒ‡çº¹éªŒè¯å¤±è´¥ï¼Œé™åˆ¶ä¿å­˜`);
                    return false;
                }
                // 1. æ£€æŸ¥æ˜¯å¦è¢«é™åˆ¶
                const restriction = StorageManager.isRestricted(username);
                if (restriction.restricted) {
                    console.warn(`ç”¨æˆ· ${username} å¤„äºé™åˆ¶æœŸï¼Œä¸èƒ½ä¿å­˜è®°å½•`);
                    return false;
                }

                // 2. æ£€æŸ¥è¯•ç”¨æœŸæ˜¯å¦è¿‡æœŸ
                if (StorageManager.isTrialExpired(username)) {
                    console.warn(`ç”¨æˆ· ${username} çš„è¯•ç”¨æœŸå·²è¿‡æœŸ`);
                    return false;
                }

                // 3. æ£€æŸ¥è¯•ç”¨æ¬¡æ•°æ»¥ç”¨
                const trialData = StorageManager.getTrialData(username);
                if (!trialData) {
                    // å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œæ£€æŸ¥æ˜¯å¦çŸ­æ—¶é—´å†…å¤šæ¬¡åˆ›å»º
                    const firstUseTime = this.getFirstUseTime(username);
                    const now = Date.now();
                    const ONE_HOUR_MS = 60 * 60 * 1000;

                    if (firstUseTime && (now - firstUseTime < ONE_HOUR_MS)) {
                        console.warn('æ£€æµ‹åˆ°çŸ­æ—¶é—´å†…å¤šæ¬¡åˆ›å»ºè¯•ç”¨è´¦æˆ·');
                        StorageManager.recordSuspiciousActivity(username);
                        return false;
                    }
                    return true;
                }

                // 4. æ£€æŸ¥æ˜¯å¦åœ¨æƒ©ç½šæœŸå†…
                if (trialData.penaltyUntil) {
                    const penaltyDate = new Date(trialData.penaltyUntil);
                    if (new Date() < penaltyDate) {
                        const hoursLeft = Math.ceil((penaltyDate - new Date()) / (60 * 60 * 1000));
                        console.warn(`ç”¨æˆ· ${username} åœ¨æƒ©ç½šæœŸå†…ï¼Œå‰©ä½™ ${hoursLeft} å°æ—¶`);
                        return false;
                    }
                }

                // 5. æ£€æŸ¥è¯•ç”¨æ¬¡æ•°
                const usedCount = trialData.count || 0;
                return usedCount < 18;
            },
            // æ–°å¢ï¼šè·å–é¦–æ¬¡ä½¿ç”¨æ—¶é—´
            getFirstUseTime: function(username) {
                // å°è¯•ä»å¤šä¸ªä½ç½®è·å–é¦–æ¬¡ä½¿ç”¨æ—¶é—´
                const sources = [
                    localStorage.getItem(`trial_first_${username}`),
                    StorageManager.getCookie(`trial_first_${username}`)
                ];

                let earliestTime = null;
                for (const source of sources) {
                    if (source) {
                        try {
                            const time = parseInt(source);
                            if (!earliestTime || time < earliestTime) {
                                earliestTime = time;
                            }
                        } catch (e) {
                            console.error('è§£æé¦–æ¬¡ä½¿ç”¨æ—¶é—´å¤±è´¥:', e);
                        }
                    }
                }

                return earliestTime;
            },


            // å¢åŠ è¯•ç”¨ç”¨æˆ·è®°å½•æ¬¡æ•°
            incrementTrialRecord: function(username) {
                // ä»å¤šå­˜å‚¨è·å–å½“å‰æ•°æ®
                let trialData = StorageManager.getTrialData(username);

                // æ£€æŸ¥è¯•ç”¨æœŸ
                if (StorageManager.isTrialExpired(username)) {
                    console.warn('è¯•ç”¨æœŸå·²è¿‡æœŸï¼Œä¸èƒ½å¢åŠ è®°å½•');
                    return false;
                }

                // æ£€æŸ¥é™åˆ¶
                const restriction = StorageManager.isRestricted(username);
                if (restriction.restricted) {
                    console.warn('è´¦å·å—é™ï¼Œä¸èƒ½å¢åŠ è®°å½•');
                    return false;
                }

                // å¦‚æœæ˜¯é¦–æ¬¡ä½¿ç”¨ï¼Œåˆå§‹åŒ–æ•°æ®
                if (!trialData) {
                    trialData = {
                        count: 0,
                        createdTimestamp: Date.now(),
                        firstUse: new Date().toISOString(),
                        lastUpdate: new Date().toISOString(),
                        attempts: 0
                    };
                }

                // å¢åŠ å°è¯•æ¬¡æ•°è®¡æ•°
                trialData.attempts = (trialData.attempts || 0) + 1;

                // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§æ¬¡æ•°
                if (trialData.count >= 18) {
                    // è®°å½•å¼‚å¸¸å°è¯•
                    trialData.abnormalAttempts = (trialData.abnormalAttempts || 0) + 1;

                    // å¦‚æœå¼‚å¸¸å°è¯•è¿‡å¤šï¼Œå»¶é•¿æƒ©ç½šæ—¶é—´
                    if (trialData.abnormalAttempts > 3) {
                        trialData.penaltyUntil = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(); // 24å°æ—¶æƒ©ç½š
                    }

                    StorageManager.setTrialData(username, trialData);
                    return false;
                }

                // æ­£å¸¸å¢åŠ æ¬¡æ•°
                trialData.count = (trialData.count || 0) + 1;
                trialData.lastUpdate = new Date().toISOString();

                // é‡ç½®å¼‚å¸¸è®¡æ•°
                trialData.abnormalAttempts = 0;

                // å­˜å‚¨åˆ°å¤šä¸ªä½ç½®
                StorageManager.setTrialData(username, trialData);

                // æ›´æ–°è¯•ç”¨ä¿¡æ¯æ˜¾ç¤º
                this.updateTrialInfo(username);
                return true;
            },

            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            showError: function(elementId, message) {
                const element = document.getElementById(elementId);
                element.textContent = message;
                element.style.display = 'block';
            },

            // éšè—é”™è¯¯æ¶ˆæ¯
            hideError: function(elementId) {
                const element = document.getElementById(elementId);
                element.style.display = 'none';
            },

            // æ¸…é™¤æ‰€æœ‰é”™è¯¯æ¶ˆæ¯
            clearAllErrors: function() {
                const errorElements = document.querySelectorAll('.error-message');
                errorElements.forEach(element => {
                    element.style.display = 'none';
                });
            },
            // åˆ·æ–°é‚€è¯·ç åˆ—è¡¨
            refreshInvitationCodeList: function() {
                console.log('refreshInvitationCodeList è¢«è°ƒç”¨');

                const invitationCodes = JSON.parse(localStorage.getItem('invitationCodes') || '[]');
                const selectElement = document.getElementById('invitationCode');

                if (!selectElement) {
                    console.error('æœªæ‰¾åˆ°é‚€è¯·ç é€‰æ‹©æ¡†');
                    return;
                }

                // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
                const currentValue = selectElement.value;

                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                while (selectElement.options.length > 0) {
                    selectElement.remove(0);
                }

                // æ·»åŠ æç¤ºé€‰é¡¹
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "è¯·é€‰æ‹©é‚€è¯·ç ";
                selectElement.appendChild(defaultOption);

                // æ·»åŠ æœªä½¿ç”¨çš„é‚€è¯·ç é€‰é¡¹
                const availableCodes = invitationCodes.filter(code => !code.used);

                console.log('å¯ç”¨çš„é‚€è¯·ç æ•°é‡:', availableCodes.length);

                if (availableCodes.length === 0) {
                    const noOption = document.createElement('option');
                    noOption.value = "";
                    noOption.textContent = "æš‚æ— å¯ç”¨é‚€è¯·ç ï¼Œè¯·å¯¼å…¥æˆ–è”ç³»ç®¡ç†å‘˜";
                    selectElement.appendChild(noOption);
                } else {
                    availableCodes.forEach(code => {
                        const option = document.createElement('option');
                        option.value = code.code;
                        let text = code.code;
                        if (code.createdBy) text += ` (æ¥è‡ª: ${code.createdBy})`;
                        if (code.createdDate) {
                            try {
                                text += ` ${new Date(code.createdDate).toLocaleDateString()}`;
                            } catch (e) {
                                console.warn('æ—¥æœŸè§£æå¤±è´¥:', code.createdDate);
                            }
                        }
                        option.textContent = text;
                        selectElement.appendChild(option);
                    });
                }

                // æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼
                if (currentValue && Array.from(selectElement.options).some(opt => opt.value === currentValue)) {
                    selectElement.value = currentValue;
                }

                console.log('é‚€è¯·ç åˆ—è¡¨åˆ·æ–°å®Œæˆ');
            },
            importViaFileInput: function() {
                const self = this;

                // åˆ›å»ºæ–‡ä»¶è¾“å…¥æ¡†
                const fileInput = document.createElement('input');
                fileInput.type = 'file';

                // è®¾ç½®acceptå±æ€§ï¼Œæ”¯æŒå¤šç§æ–‡ä»¶ç±»å‹å’ŒMIMEç±»å‹
                fileInput.accept = '.dat,.txt,.json,.csv,text/plain,application/json,text/csv';

                // é’ˆå¯¹ç§»åŠ¨ç«¯çš„ä¼˜åŒ–
                if (/Android/i.test(navigator.userAgent)) {
                    // Androidè®¾å¤‡ï¼šå°è¯•ç¦ç”¨ç›¸æœº
                    fileInput.setAttribute('capture', 'filesystem');
                } else if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    // iOSè®¾å¤‡ï¼šä½¿ç”¨æ›´é€šç”¨çš„accept
                    fileInput.accept = 'public.item,.dat,.txt,.json,.csv';
                }

                fileInput.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            z-index: 9999;
        `;

                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) {
                        // ç”¨æˆ·å–æ¶ˆé€‰æ‹©
                        setTimeout(() => {
                            if (fileInput.parentNode) {
                                document.body.removeChild(fileInput);
                            }
                        }, 100);
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(event) {
                        self.processImportedFile(event.target.result, file.name);

                        // æ¸…ç†
                        setTimeout(() => {
                            if (fileInput.parentNode) {
                                document.body.removeChild(fileInput);
                            }
                        }, 100);
                    };

                    reader.onerror = function() {
                        alert('è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•');
                        if (fileInput.parentNode) {
                            document.body.removeChild(fileInput);
                        }
                    };

                    reader.readAsText(file);
                };

                // å¤„ç†å–æ¶ˆé€‰æ‹©
                fileInput.oncancel = function() {
                    setTimeout(() => {
                        if (fileInput.parentNode) {
                            document.body.removeChild(fileInput);
                        }
                    }, 100);
                };

                // æ·»åŠ åˆ°DOMå¹¶è§¦å‘ç‚¹å‡»
                document.body.appendChild(fileInput);

                // ä½¿ç”¨setTimeoutç¡®ä¿DOMå·²æ›´æ–°
                setTimeout(() => {
                    try {
                        fileInput.click();
                    } catch (err) {
                        console.error('è§¦å‘æ–‡ä»¶é€‰æ‹©å¤±è´¥:', err);
                        // å¦‚æœç›´æ¥ç‚¹å‡»å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨dispatchEvent
                        const clickEvent = new MouseEvent('click', {
                            view: window,
                            bubbles: true,
                            cancelable: true
                        });
                        fileInput.dispatchEvent(clickEvent);
                    }
                }, 50);

                // è®¾ç½®è¶…æ—¶è‡ªåŠ¨æ¸…ç†ï¼ˆ10ç§’åï¼‰
                setTimeout(() => {
                    if (fileInput.parentNode) {
                        document.body.removeChild(fileInput);
                    }
                }, 10000);
            },
            // æ–¹æ³•2ï¼šæ‰‹åŠ¨è¾“å…¥
            importManually: function() {
                // ä½¿ç”¨ç®€å•çš„prompt
                const input = prompt('è¯·è¾“å…¥é‚€è¯·ç ï¼ˆå¤šä¸ªé‚€è¯·ç ç”¨é€—å·ã€ç©ºæ ¼æˆ–æ¢è¡Œåˆ†éš”ï¼‰ï¼š\n\nä¾‹å¦‚ï¼š\nABC123, DEF456\næˆ–\nABC123\nDEF456');

                if (!input || input.trim() === '') {
                    return;
                }

                // å¤„ç†å¤šç§åˆ†éš”ç¬¦
                let codes = [];

                // 1. å°è¯•ç”¨é€—å·åˆ†å‰²
                if (input.includes(',')) {
                    codes = input.split(',')
                        .map(code => code.trim())
                        .filter(code => code !== '');
                }
                // 2. å°è¯•ç”¨ç©ºæ ¼åˆ†å‰²
                else if (input.includes(' ') || input.includes('  ') || input.includes('\t')) {
                    // æ›¿æ¢æ‰€æœ‰ç©ºç™½å­—ç¬¦ä¸ºç©ºæ ¼ï¼Œç„¶ååˆ†å‰²
                    codes = input.replace(/\s+/g, ' ')
                        .split(' ')
                        .map(code => code.trim())
                        .filter(code => code !== '');
                }
                // 3. å°è¯•ç”¨æ¢è¡Œåˆ†å‰²
                else if (input.includes('\n')) {
                    codes = input.split('\n')
                        .map(code => code.trim())
                        .filter(code => code !== '');
                }
                // 4. åªæœ‰ä¸€ä¸ªé‚€è¯·ç 
                else {
                    codes = [input.trim()];
                }

                if (codes.length === 0) {
                    alert('âŒ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„é‚€è¯·ç ');
                    return;
                }

                // æ„å»ºæ•°æ®
                const data = {
                    invitationCodes: codes.map(code => ({
                        code: code,
                        createdBy: 'æ‰‹åŠ¨è¾“å…¥',
                        createdDate: new Date().toISOString(),
                        used: false
                    }))
                };

                const content = JSON.stringify(data, null, 2);
                const result = this.processImportedFile(content);

                if (result) {
                    // åˆ·æ–°æ³¨å†Œè¡¨å•
                    this.hideAllModals();
                    setTimeout(() => {
                        this.showRegisterModal();
                    }, 300);
                }
            },
            // å¤„ç†å¯¼å…¥çš„æ–‡ä»¶å†…å®¹
            processImportedFile: function(content, fileName = '') {
                const self = this;
                try {
                    console.log('å¼€å§‹å¤„ç†æ–‡ä»¶å†…å®¹');

                    let invitationCodes = [];

                    // 1. å°è¯•JSONæ ¼å¼
                    if (content.trim().startsWith('{') || content.trim().startsWith('[')) {
                        try {
                            const data = JSON.parse(content);
                            if (data.invitationCodes) {
                                invitationCodes = data.invitationCodes;
                                console.log('JSONè§£ææˆåŠŸï¼Œæ‰¾åˆ°é‚€è¯·ç æ•°ç»„');
                            } else if (Array.isArray(data)) {
                                invitationCodes = data.map(code => ({
                                    code: typeof code === 'string' ? code : code.code,
                                    createdBy: 'å¯¼å…¥',
                                    createdDate: new Date().toISOString(),
                                    used: false
                                }));
                                console.log('JSONè§£ææˆåŠŸï¼Œæ‰¾åˆ°æ•°ç»„æ•°æ®');
                            }
                        } catch (e) {
                            console.log('JSONè§£æå¤±è´¥');
                            // ä¸æ˜¯JSONï¼Œç»§ç»­å°è¯•å…¶ä»–æ ¼å¼
                        }
                    }
                    // 2. å¦‚æœæ˜¯CSVæ ¼å¼
                    if (invitationCodes.length === 0 && content.includes(',')) {
                        console.log('å°è¯•è§£æCSVæ ¼å¼');
                        const lines = content.split('\n');
                        lines.forEach(line => {
                            const parts = line.split(',').map(part => part.trim());
                            if (parts[0] && parts[0] !== 'é‚€è¯·ç ') {
                                invitationCodes.push({
                                    code: parts[0],
                                    createdBy: parts[1] || 'å¯¼å…¥',
                                    createdDate: parts[2] || new Date().toISOString(),
                                    used: false
                                });
                            }
                        });
                    }

                    // 3. çº¯æ–‡æœ¬æ ¼å¼ï¼ˆæ¯è¡Œä¸€ä¸ªé‚€è¯·ç ï¼‰
                    if (invitationCodes.length === 0) {
                        console.log('å°è¯•è§£æçº¯æ–‡æœ¬æ ¼å¼');
                        invitationCodes = content.split('\n')
                            .filter(line => {
                                const trimmed = line.trim();
                                return trimmed !== '' && !trimmed.startsWith('#') && !trimmed.startsWith('//');
                            })
                            .map(line => ({
                                code: line.trim(),
                                createdBy: 'å¯¼å…¥',
                                createdDate: new Date().toISOString(),
                                used: false
                            }));
                    }

                    console.log('è§£æç»“æœï¼šæ‰¾åˆ°', invitationCodes.length, 'ä¸ªé‚€è¯·ç ');

                    if (invitationCodes.length > 0) {
                        const existing = JSON.parse(localStorage.getItem('invitationCodes') || '[]');

                        // åˆå¹¶å¹¶å»é‡
                        const newInvites = invitationCodes.filter(newCode => {
                            return !existing.find(existingCode => existingCode.code === newCode.code);
                        });

                        console.log('å»é‡åæ–°å¢ï¼š', newInvites.length, 'ä¸ª');

                        const updated = [...existing, ...newInvites];
                        localStorage.setItem('invitationCodes', JSON.stringify(updated));

                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        if (newInvites.length > 0) {
                            let message = `âœ… æˆåŠŸå¯¼å…¥ ${newInvites.length} ä¸ªé‚€è¯·ç ï¼`;
                            if (newInvites.length <= 10) {
                                message += "\n\næ–°æ·»åŠ çš„é‚€è¯·ç ï¼š\n" + newInvites.map(c => c.code).join('\n');
                            } else {
                                message += "\n\nå‰10ä¸ªé‚€è¯·ç ï¼š\n" + newInvites.slice(0, 10).map(c => c.code).join('\n') +
                                    "\n... ç­‰";
                            }
                            alert(message);

                            // åˆ·æ–°é‚€è¯·ç åˆ—è¡¨
                            self.refreshInvitationCodeList();
                        } else {
                            alert('âš ï¸ æ²¡æœ‰æ–°çš„é‚€è¯·ç è¢«æ·»åŠ ï¼ˆå¯èƒ½æ‰€æœ‰é‚€è¯·ç éƒ½å·²å­˜åœ¨ï¼‰');
                        }

                        return true;
                    } else {
                        alert('âŒ æ— æ³•è¯†åˆ«æ–‡ä»¶æ ¼å¼ï¼Œè¯·ç¡®ä¿æ–‡ä»¶åŒ…å«é‚€è¯·ç æ•°æ®');
                        return false;
                    }

                } catch (err) {
                    console.error('æ–‡ä»¶å¤„ç†é”™è¯¯:', err);
                    alert('âŒ å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™: ' + err.message);
                    return false;
                }
            },
            // è‡ªå®šä¹‰å¼¹çª—ç›¸å…³æ–¹æ³•
            showCustomModal: function(title, content) {
                const modalId = 'custom-modal';
                let modal = document.getElementById(modalId);

                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = modalId;
                    modal.className = 'modal';
                    modal.innerHTML = `
                <div class="modal-content" style="max-width: 350px;">
                    <div class="modal-header">
                        <h2 class="modal-title">${title}</h2>
                    </div>
                    <div id="custom-modal-body" style="padding: 0 10px 20px 10px;">
                        ${content}
                    </div>
                </div>
            `;
                    document.body.appendChild(modal);

                    // ç‚¹å‡»èƒŒæ™¯å…³é—­
                    modal.addEventListener('click', (e) => {
                        if (e.target.id === modalId) {
                            this.hideCustomModal();
                        }
                    });
                }

                modal.style.display = 'flex';
            },

            hideCustomModal: function() {
                const modal = document.getElementById('custom-modal');
                if (modal) {
                    modal.style.display = 'none';
                    // å¯é€‰ï¼šç§»é™¤DOMå…ƒç´ 
                    // document.body.removeChild(modal);
                }
            }

        };

        // ============== ç›˜å£ç±»å‹åˆ‡æ¢åŠŸèƒ½ ============== //
        function initHandicapTabs() {
            console.log('åˆå§‹åŒ–ç›˜å£ç±»å‹åˆ‡æ¢...');

            const tabs = document.querySelectorAll('.handicap-tab');
            const contents = document.querySelectorAll('.handicap-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabType = this.getAttribute('data-tab');

                    // ç§»é™¤æ‰€æœ‰activeç±»
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));

                    // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾å’Œå†…å®¹
                    this.classList.add('active');
                    document.getElementById(`${tabType}-content`).classList.add('active');

                    console.log(`åˆ‡æ¢åˆ°ç›˜å£ç±»å‹: ${tabType}`);
                });
            });
        }

        function initHandicapOptions() {
            console.log('åˆå§‹åŒ–ç›˜å£å’Œæ°´ä½é€‰é¡¹...');

            // åˆå§‹åŒ–è®©çƒç›˜ç›˜å£é€‰é¡¹ï¼ˆ0-3ï¼Œé€’å¢0.25ï¼‰
            const asianInitialHandicapSelect = document.getElementById('asian-initial-handicap');
            const asianCurrentHandicapSelect = document.getElementById('asian-current-handicap');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            asianInitialHandicapSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            asianCurrentHandicapSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';

            // è®©çƒç›˜ç›˜å£é€‰é¡¹ï¼ˆ0-3ï¼Œé€’å¢0.25ï¼‰
            const asianHandicapOptions = [0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2, 2.25, 2.5, 2.75, 3];
            asianHandicapOptions.forEach(value => {
                const option1 = document.createElement('option');
                option1.value = value.toFixed(2);
                option1.textContent = value.toFixed(2);
                asianInitialHandicapSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = value.toFixed(2);
                option2.textContent = value.toFixed(2);
                asianCurrentHandicapSelect.appendChild(option2.cloneNode(true));
            });

            console.log(`è®©çƒç›˜ç›˜å£é€‰é¡¹åˆå§‹åŒ–å®Œæˆï¼Œå…± ${asianHandicapOptions.length} ä¸ªé€‰é¡¹`);

            // åˆå§‹åŒ–å¤§å°ç›˜ç›˜å£é€‰é¡¹ï¼ˆ1.5-4ï¼Œé€’å¢0.25ï¼‰
            const sizeInitialHandicapSelect = document.getElementById('size-initial-handicap');
            const sizeCurrentHandicapSelect = document.getElementById('size-current-handicap');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            sizeInitialHandicapSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            sizeCurrentHandicapSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';

            // å¤§å°ç›˜ç›˜å£é€‰é¡¹ï¼ˆ1.5-4ï¼Œé€’å¢0.25ï¼‰
            const sizeHandicapOptions = [];
            for (let i = 1.5; i <= 4; i += 0.25) {
                sizeHandicapOptions.push(i);
            }
            sizeHandicapOptions.forEach(value => {
                const option1 = document.createElement('option');
                option1.value = value.toFixed(2);
                option1.textContent = value.toFixed(2);
                sizeInitialHandicapSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = value.toFixed(2);
                option2.textContent = value.toFixed(2);
                sizeCurrentHandicapSelect.appendChild(option2.cloneNode(true));
            });

            console.log(`å¤§å°ç›˜ç›˜å£é€‰é¡¹åˆå§‹åŒ–å®Œæˆï¼Œå…± ${sizeHandicapOptions.length} ä¸ªé€‰é¡¹`);
        }

        function initWaterOptions() {
            console.log('åˆå§‹åŒ–æ°´ä½é€‰é¡¹...');

            // åˆå§‹åŒ–æ°´ä½é€‰é¡¹ï¼ˆ0.7-1.2ï¼Œé€’å¢0.01ï¼‰
            const asianInitialWaterSelect = document.getElementById('asian-initial-water');
            const asianCurrentWaterSelect = document.getElementById('asian-current-water');
            const sizeInitialWaterSelect = document.getElementById('size-initial-water');
            const sizeCurrentWaterSelect = document.getElementById('size-current-water');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            asianInitialWaterSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            asianCurrentWaterSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            sizeInitialWaterSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            sizeCurrentWaterSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';

            // ä¼˜åŒ–ï¼šå‡å°‘é€‰é¡¹æ•°é‡ï¼Œåªæ˜¾ç¤ºå¸¸ç”¨æ°´ä½
            const waterOptions = [];
            for (let i = 0.70; i <= 1.20; i += 0.01) {
                waterOptions.push(i);
            }
            waterOptions.forEach(value => {
                const option1 = document.createElement('option');
                option1.value = value.toFixed(2);
                option1.textContent = value.toFixed(2);
                asianInitialWaterSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = value.toFixed(2);
                option2.textContent = value.toFixed(2);
                asianCurrentWaterSelect.appendChild(option2.cloneNode(true));

                const option3 = document.createElement('option');
                option3.value = value.toFixed(2);
                option3.textContent = value.toFixed(2);
                sizeInitialWaterSelect.appendChild(option3.cloneNode(true));

                const option4 = document.createElement('option');
                option4.value = value.toFixed(2);
                option4.textContent = value.toFixed(2);
                sizeCurrentWaterSelect.appendChild(option4.cloneNode(true));
            });

            console.log(`æ°´ä½é€‰é¡¹åˆå§‹åŒ–å®Œæˆï¼Œå…± ${waterOptions.length} ä¸ªé€‰é¡¹`);
        }

        // ============== æ·»åŠ é‚€è¯·ç åŠŸèƒ½äº‹ä»¶ç»‘å®š ============== //

        // ç»‘å®šæ–‡ä»¶å¯¼å…¥æŒ‰é’®
        const fileImportBtn = document.getElementById('fileImportBtn');
        if (fileImportBtn) {
            console.log('æ‰¾åˆ°æ–‡ä»¶å¯¼å…¥æŒ‰é’®');
            fileImportBtn.addEventListener('click', function(e) {
                console.log('æ–‡ä»¶å¯¼å…¥æŒ‰é’®è¢«ç‚¹å‡»');
                e.preventDefault();
                e.stopPropagation();

                // ç›´æ¥è°ƒç”¨æ–¹æ³•
                try {
                    UserSystem.importViaFileInput();
                } catch (err) {
                    console.error('å¯¼å…¥å¤±è´¥:', err);
                    alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                }
            });
        } else {
            console.error('æœªæ‰¾åˆ°æ–‡ä»¶å¯¼å…¥æŒ‰é’®');
        }

        function initEventListeners() {
            console.log('åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨...');

            // ç»‘å®šè¡¨å•æŒ‰é’®äº‹ä»¶
            document.getElementById('save-asian-btn').addEventListener('click', saveAsianRecord);
            document.getElementById('reset-asian-btn').addEventListener('click', resetAsianForm);
            document.getElementById('save-size-btn').addEventListener('click', saveSizeRecord);
            document.getElementById('reset-size-btn').addEventListener('click', resetSizeForm);
            document.getElementById('toggle-history').addEventListener('click', toggleHistory);
            document.getElementById('clear-history').addEventListener('click', clearHistory);

            // ç»‘å®šæ¨¡æ€æ¡†äº‹ä»¶
            document.getElementById('loginBtn').addEventListener('click', () => UserSystem.login());
            document.getElementById('cancelLoginBtn').addEventListener('click', () => UserSystem.hideAllModals());
            document.getElementById('registerBtn').addEventListener('click', () => UserSystem.register());
            document.getElementById('cancelRegisterBtn').addEventListener('click', () => UserSystem.hideAllModals());
            document.getElementById('showRegisterLink').addEventListener('click', () => {
                UserSystem.hideAllModals();
                UserSystem.showRegisterModal();
            });
            document.getElementById('showLoginLink').addEventListener('click', () => {
                UserSystem.hideAllModals();
                UserSystem.showLoginModal();
            });

            // ä¸ºè®©çƒç›˜æ‰€æœ‰è¾“å…¥æ¡†æ·»åŠ changeäº‹ä»¶ï¼Œç”¨äºè‡ªåŠ¨è®¡ç®—æ¨èç»“æœ
            document.getElementById('asian-initial-handicap').addEventListener('change', autoCalculateAsianRecommendation);
            document.getElementById('asian-current-handicap').addEventListener('change', autoCalculateAsianRecommendation);
            document.getElementById('asian-initial-water').addEventListener('change', autoCalculateAsianRecommendation);
            document.getElementById('asian-current-water').addEventListener('change', autoCalculateAsianRecommendation);
            document.getElementById('asian-historical-record').addEventListener('change', autoCalculateAsianRecommendation);

            // ä¸ºå¤§å°ç›˜æ‰€æœ‰è¾“å…¥æ¡†æ·»åŠ changeäº‹ä»¶ï¼Œç”¨äºè‡ªåŠ¨è®¡ç®—æ¨èç»“æœ
            document.getElementById('size-initial-handicap').addEventListener('change', autoCalculateSizeRecommendation);
            document.getElementById('size-current-handicap').addEventListener('change', autoCalculateSizeRecommendation);
            document.getElementById('size-initial-water').addEventListener('change', autoCalculateSizeRecommendation);
            document.getElementById('size-current-water').addEventListener('change', autoCalculateSizeRecommendation);
            document.getElementById('size-historical-record').addEventListener('change', autoCalculateSizeRecommendation);

            console.log('äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ');
        }

        // ä¸»åˆå§‹åŒ–å‡½æ•°
        function initializeApplication() {
            console.log('=== å¼€å§‹åº”ç”¨ç¨‹åºåˆå§‹åŒ– ===');

            // ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–ç”¨æˆ·ç³»ç»Ÿï¼ˆåŒ…å«æŒ‡çº¹ï¼‰
            UserSystem.init();

            // ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–ç›˜å£ç±»å‹åˆ‡æ¢
            initHandicapTabs();

            // ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ–ç›˜å£å’Œæ°´ä½é€‰é¡¹
            initHandicapOptions();
            initWaterOptions();

            // ç¬¬å››æ­¥ï¼šåŠ è½½å†å²è®°å½•
            loadHistory();

            // ç¬¬äº”æ­¥ï¼šåˆå§‹åŒ–å›¾è¡¨
            initChart();

            // ç¬¬å…­æ­¥ï¼šåˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            initEventListeners();

            // ç¬¬ä¸ƒæ­¥ï¼šç§»åŠ¨ç«¯ä¼˜åŒ–
            initMobileOptimization();

            console.log('=== åº”ç”¨ç¨‹åºåˆå§‹åŒ–å®Œæˆ ===');
        }

        // ç§»åŠ¨ç«¯ä¼˜åŒ–
        function initMobileOptimization() {
            console.log('åˆå§‹åŒ–ç§»åŠ¨ç«¯ä¼˜åŒ–...');

            // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šé˜²æ­¢ç‚¹å‡»æ—¶å‡ºç°è“è‰²é«˜äº®
            document.querySelectorAll('button, select').forEach(element => {
                element.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.98)';
                });
                element.addEventListener('touchend', function() {
                    this.style.transform = '';
                });
            });
            // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šé˜²æ­¢åŒå‡»ç¼©æ”¾
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            console.log('ç§»åŠ¨ç«¯ä¼˜åŒ–å®Œæˆ');
        }

        // ============== é¡µé¢åŠ è½½å…¥å£ ============== //
        // DOMåŠ è½½å®Œæˆåå¼€å§‹åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMå†…å®¹åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åº”ç”¨ç¨‹åº...');

            // è°ƒç”¨ä¸»åˆå§‹åŒ–å‡½æ•°
            initializeApplication();

            // å»¶è¿Ÿæ‰§è¡Œé‚€è¯·ç æŒ‰é’®ç»‘å®šï¼ˆç¡®ä¿DOMå®Œå…¨å°±ç»ªï¼‰
            setTimeout(function() {
                bindInvitationCodeButtons();
            }, 100);
        });

        // é‚€è¯·ç åŠŸèƒ½äº‹ä»¶ç»‘å®š
        function bindInvitationCodeButtons() {
            console.log('ç»‘å®šé‚€è¯·ç æŒ‰é’®äº‹ä»¶...');

            // ç»‘å®šæ–‡ä»¶å¯¼å…¥æŒ‰é’®
            const fileImportBtn = document.getElementById('fileImportBtn');
            if (fileImportBtn) {
                console.log('æ‰¾åˆ°æ–‡ä»¶å¯¼å…¥æŒ‰é’®');
                fileImportBtn.addEventListener('click', function(e) {
                    console.log('æ–‡ä»¶å¯¼å…¥æŒ‰é’®è¢«ç‚¹å‡»');
                    e.preventDefault();
                    e.stopPropagation();

                    try {
                        UserSystem.importViaFileInput();
                    } catch (err) {
                        console.error('å¯¼å…¥å¤±è´¥:', err);
                        alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                    }
                });
            } else {
                console.error('æœªæ‰¾åˆ°æ–‡ä»¶å¯¼å…¥æŒ‰é’®');
            }

            // ç»‘å®šæ‰‹åŠ¨è¾“å…¥æŒ‰é’®
            const manualImportBtn = document.getElementById('manualImportBtn');
            if (manualImportBtn) {
                console.log('æ‰¾åˆ°æ‰‹åŠ¨è¾“å…¥æŒ‰é’®');
                manualImportBtn.addEventListener('click', function(e) {
                    console.log('æ‰‹åŠ¨è¾“å…¥æŒ‰é’®è¢«ç‚¹å‡»');
                    e.preventDefault();
                    e.stopPropagation();

                    try {
                        UserSystem.importManually();
                    } catch (err) {
                        console.error('æ‰‹åŠ¨è¾“å…¥å¤±è´¥:', err);
                        alert('æ‰‹åŠ¨è¾“å…¥å¤±è´¥: ' + err.message);
                    }
                });
            } else {
                console.error('æœªæ‰¾åˆ°æ‰‹åŠ¨è¾“å…¥æŒ‰é’®');
            }

            // ç»‘å®šåˆ·æ–°é‚€è¯·ç åˆ—è¡¨æŒ‰é’®
            const refreshBtn = document.getElementById('refreshInviteListBtn');
            if (refreshBtn) {
                console.log('æ‰¾åˆ°åˆ·æ–°æŒ‰é’®');
                refreshBtn.addEventListener('click', function(e) {
                    console.log('åˆ·æ–°æŒ‰é’®è¢«ç‚¹å‡»');
                    e.preventDefault();
                    e.stopPropagation();

                    try {
                        UserSystem.refreshInvitationCodeList();
                        alert('é‚€è¯·ç åˆ—è¡¨å·²åˆ·æ–°');
                    } catch (err) {
                        console.error('åˆ·æ–°å¤±è´¥:', err);
                        alert('åˆ·æ–°å¤±è´¥: ' + err.message);
                    }
                });
            } else {
                console.error('æœªæ‰¾åˆ°åˆ·æ–°æŒ‰é’®');
            }

            console.log('é‚€è¯·ç æŒ‰é’®äº‹ä»¶ç»‘å®šå®Œæˆ');
        }

        // ============== è®©çƒç›˜è®¡ç®—å‡½æ•° ============== //
        function autoCalculateAsianRecommendation() {
            const initialHandicap = parseFloat(document.getElementById('asian-initial-handicap').value);
            const currentHandicap = parseFloat(document.getElementById('asian-current-handicap').value);
            const initialWater = parseFloat(document.getElementById('asian-initial-water').value);
            const currentWater = parseFloat(document.getElementById('asian-current-water').value);
            const historicalRecord = document.getElementById('asian-historical-record').value;

            // å¦‚æœæ‰€æœ‰å­—æ®µéƒ½æœ‰å€¼ï¼Œåˆ™è®¡ç®—æ¨èç»“æœ
            if (!isNaN(initialHandicap) && !isNaN(currentHandicap) &&
                !isNaN(initialWater) && !isNaN(currentWater) &&
                historicalRecord) {
                calculateAsianRecommendation();
            } else {
                // å¦åˆ™æ˜¾ç¤ºç­‰å¾…è¾“å…¥
                const resultElement = document.getElementById('asian-recommendation-result');
                resultElement.textContent = "ç­‰å¾…è¾“å…¥";
                resultElement.className = "recommendation-result recommendation-neutral";
                document.getElementById('asian-recommendation-details').textContent = "è¯·å¡«å†™æ‰€æœ‰å­—æ®µä»¥è·å–æ¨èç»“æœ";
            }
        }

        function calculateAsianRecommendation() {
            const initialHandicap = parseFloat(document.getElementById('asian-initial-handicap').value);
            const currentHandicap = parseFloat(document.getElementById('asian-current-handicap').value);
            const initialWater = parseFloat(document.getElementById('asian-initial-water').value);
            const currentWater = parseFloat(document.getElementById('asian-current-water').value);
            const historicalRecord = document.getElementById('asian-historical-record').value;

            // éªŒè¯è¾“å…¥
            if (isNaN(initialHandicap) || isNaN(currentHandicap) ||
                isNaN(initialWater) || isNaN(currentWater) ||
                !historicalRecord) {
                return;
            }

            // è®¡ç®—ç›˜å£å’Œæ°´ä½å˜åŒ–
            const handicapChange = currentHandicap - initialHandicap;
            const waterChange = currentWater - initialWater;

            // ç¡®å®šç›˜å£å˜åŒ–æ–¹å‘
            const handicapUp = handicapChange > 0;
            const handicapDown = handicapChange < 0;

            // ç¡®å®šæ°´ä½å˜åŒ–æ–¹å‘
            const waterUp = waterChange > 0;
            const waterDown = waterChange < 0;

            let recommendation = "";

            // æ ¹æ®è§„åˆ™è®¡ç®—æ¨èç»“æœ
            // è§„åˆ™1: ç›˜å£å‡ï¼Œæ°´ä½å‡ï¼Œå†å²æˆ˜ç»©èµ¢ -> ä¸‹ç›˜
            if (handicapUp && waterUp && historicalRecord === "win") {
                recommendation = "ä¸‹ç›˜";
            }
            // è§„åˆ™2: ç›˜å£å‡ï¼Œæ°´ä½å‡ï¼Œå†å²æˆ˜ç»©è¾“ -> ä¸Šç›˜
            else if (handicapUp && waterUp && historicalRecord === "loss") {
                recommendation = "ä¸Šç›˜";
            }
            // è§„åˆ™3: ç›˜å£é™ï¼Œæ°´ä½å‡ï¼Œå†å²æˆ˜ç»©è¾“ -> ä¸‹ç›˜
            else if (handicapDown && waterUp && historicalRecord === "loss") {
                recommendation = "ä¸‹ç›˜";
            }
            // è§„åˆ™4: ç›˜å£é™ï¼Œæ°´ä½å‡ï¼Œå†å²æˆ˜ç»©èµ¢ -> ä¸Šç›˜
            else if (handicapDown && waterUp && historicalRecord === "win") {
                recommendation = "ä¸Šç›˜";
            }
            // è§„åˆ™5: ç›˜å£å‡ï¼Œæ°´ä½é™ï¼Œå†å²æˆ˜ç»©è¾“ -> ä¸‹ç›˜
            else if (handicapUp && waterDown && historicalRecord === "loss") {
                recommendation = "ä¸‹ç›˜";
            }
            // è§„åˆ™6: ç›˜å£å‡ï¼Œæ°´ä½é™ï¼Œå†å²æˆ˜ç»©èµ¢ -> ä¸Šç›˜
            else if (handicapUp && waterDown && historicalRecord === "win") {
                recommendation = "ä¸Šç›˜";
            }
            // è§„åˆ™7: ç›˜å£é™ï¼Œæ°´ä½é™ï¼Œå†å²æˆ˜ç»©è¾“ -> ä¸Šç›˜
            else if (handicapDown && waterDown && historicalRecord === "loss") {
                recommendation = "ä¸Šç›˜";
            }
            // è§„åˆ™8: ç›˜å£é™ï¼Œæ°´ä½é™ï¼Œå†å²æˆ˜ç»©èµ¢ -> ä¸‹ç›˜
            else if (handicapDown && waterDown && historicalRecord === "win") {
                recommendation = "ä¸‹ç›˜";
            } else {
                // å¦‚æœæ²¡æœ‰åŒ¹é…çš„è§„åˆ™ï¼ˆä¾‹å¦‚ç›˜å£æˆ–æ°´ä½æ— å˜åŒ–ï¼‰
                recommendation = "æ— æ˜ç¡®æ¨è";
            }

            // æ˜¾ç¤ºæ¨èç»“æœ
            const resultElement = document.getElementById('asian-recommendation-result');
            resultElement.textContent = recommendation;
            if (recommendation === "ä¸Šç›˜") {
                resultElement.className = "recommendation-result recommendation-up";
            } else if (recommendation === "ä¸‹ç›˜") {
                resultElement.className = "recommendation-result recommendation-down";
            } else {
                resultElement.className = "recommendation-result recommendation-neutral";
            }

            // æ˜¾ç¤ºå˜åŒ–è¯¦æƒ…
            const handicapChangeText = handicapChange > 0 ? `ç›˜å£ä¸Šå‡ ${Math.abs(handicapChange)}` :
                handicapChange < 0 ? `ç›˜å£ä¸‹é™ ${Math.abs(handicapChange)}` : "ç›˜å£æ— å˜åŒ–";
            const waterChangeText = waterChange > 0 ? `æ°´ä½ä¸Šå‡ ${Math.abs(waterChange.toFixed(2))}` :
                waterChange < 0 ? `æ°´ä½ä¸‹é™ ${Math.abs(waterChange.toFixed(2))}` : "æ°´ä½æ— å˜åŒ–";
            const historicalText = historicalRecord === "win" ? "å†å²æˆ˜ç»©: èµ¢" : "å†å²æˆ˜ç»©: è¾“";

            document.getElementById('asian-recommendation-details').textContent =
                `${handicapChangeText} | ${waterChangeText} | ${historicalText}`;
        }

        // ============== å¤§å°ç›˜è®¡ç®—å‡½æ•° ============== //
        function autoCalculateSizeRecommendation() {
            const initialHandicap = parseFloat(document.getElementById('size-initial-handicap').value);
            const currentHandicap = parseFloat(document.getElementById('size-current-handicap').value);
            const initialWater = parseFloat(document.getElementById('size-initial-water').value);
            const currentWater = parseFloat(document.getElementById('size-current-water').value);
            const historicalRecord = document.getElementById('size-historical-record').value;

            // å¦‚æœæ‰€æœ‰å­—æ®µéƒ½æœ‰å€¼ï¼Œåˆ™è®¡ç®—æ¨èç»“æœ
            if (!isNaN(initialHandicap) && !isNaN(currentHandicap) &&
                !isNaN(initialWater) && !isNaN(currentWater) &&
                historicalRecord) {
                calculateSizeRecommendation();
            } else {
                // å¦åˆ™æ˜¾ç¤ºç­‰å¾…è¾“å…¥
                const resultElement = document.getElementById('size-recommendation-result');
                resultElement.textContent = "ç­‰å¾…è¾“å…¥";
                resultElement.className = "recommendation-result size-recommendation-neutral";
                document.getElementById('size-recommendation-details').textContent = "è¯·å¡«å†™æ‰€æœ‰å­—æ®µä»¥è·å–æ¨èç»“æœ";
            }
        }

        function calculateSizeRecommendation() {
            const initialHandicap = parseFloat(document.getElementById('size-initial-handicap').value);
            const currentHandicap = parseFloat(document.getElementById('size-current-handicap').value);
            const initialWater = parseFloat(document.getElementById('size-initial-water').value);
            const currentWater = parseFloat(document.getElementById('size-current-water').value);
            const historicalRecord = document.getElementById('size-historical-record').value;

            // éªŒè¯è¾“å…¥
            if (isNaN(initialHandicap) || isNaN(currentHandicap) ||
                isNaN(initialWater) || isNaN(currentWater) ||
                !historicalRecord) {
                return;
            }

            // è®¡ç®—ç›˜å£å’Œæ°´ä½å˜åŒ–
            const handicapChange = currentHandicap - initialHandicap;
            const waterChange = currentWater - initialWater;

            // ç¡®å®šç›˜å£å˜åŒ–æ–¹å‘
            const handicapUp = handicapChange > 0;
            const handicapDown = handicapChange < 0;

            // ç¡®å®šæ°´ä½å˜åŒ–æ–¹å‘
            const waterUp = waterChange > 0;
            const waterDown = waterChange < 0;

            let recommendation = "";

            // æ ¹æ®è§„åˆ™è®¡ç®—æ¨èç»“æœï¼ˆä¸è®©çƒç›˜ç›¸åŒè§„åˆ™ï¼Œä½†è¾“å‡ºä¸åŒï¼‰
            // è§„åˆ™1: ç›˜å£å‡ï¼Œæ°´ä½å‡ï¼Œå†å²æˆ˜ç»©èµ¢ -> å°çƒ
            if (handicapUp && waterUp && historicalRecord === "win") {
                recommendation = "å°çƒ";
            }
            // è§„åˆ™2: ç›˜å£å‡ï¼Œæ°´ä½å‡ï¼Œå†å²æˆ˜ç»©è¾“ -> å¤§çƒ
            else if (handicapUp && waterUp && historicalRecord === "loss") {
                recommendation = "å¤§çƒ";
            }
            // è§„åˆ™3: ç›˜å£é™ï¼Œæ°´ä½å‡ï¼Œå†å²æˆ˜ç»©è¾“ -> å°çƒ
            else if (handicapDown && waterUp && historicalRecord === "loss") {
                recommendation = "å°çƒ";
            }
            // è§„åˆ™4: ç›˜å£é™ï¼Œæ°´ä½å‡ï¼Œå†å²æˆ˜ç»©èµ¢ -> å¤§çƒ
            else if (handicapDown && waterUp && historicalRecord === "win") {
                recommendation = "å¤§çƒ";
            }
            // è§„åˆ™5: ç›˜å£å‡ï¼Œæ°´ä½é™ï¼Œå†å²æˆ˜ç»©è¾“ -> å°çƒ
            else if (handicapUp && waterDown && historicalRecord === "loss") {
                recommendation = "å°çƒ";
            }
            // è§„åˆ™6: ç›˜å£å‡ï¼Œæ°´ä½é™ï¼Œå†å²æˆ˜ç»©èµ¢ -> å¤§çƒ
            else if (handicapUp && waterDown && historicalRecord === "win") {
                recommendation = "å¤§çƒ";
            }
            // è§„åˆ™7: ç›˜å£é™ï¼Œæ°´ä½é™ï¼Œå†å²æˆ˜ç»©è¾“ -> å¤§çƒ
            else if (handicapDown && waterDown && historicalRecord === "loss") {
                recommendation = "å¤§çƒ";
            }
            // è§„åˆ™8: ç›˜å£é™ï¼Œæ°´ä½é™ï¼Œå†å²æˆ˜ç»©èµ¢ -> å°çƒ
            else if (handicapDown && waterDown && historicalRecord === "win") {
                recommendation = "å°çƒ";
            } else {
                // å¦‚æœæ²¡æœ‰åŒ¹é…çš„è§„åˆ™ï¼ˆä¾‹å¦‚ç›˜å£æˆ–æ°´ä½æ— å˜åŒ–ï¼‰
                recommendation = "æ— æ˜ç¡®æ¨è";
            }

            // æ˜¾ç¤ºæ¨èç»“æœ
            const resultElement = document.getElementById('size-recommendation-result');
            resultElement.textContent = recommendation;
            if (recommendation === "å¤§çƒ") {
                resultElement.className = "recommendation-result size-recommendation-up";
            } else if (recommendation === "å°çƒ") {
                resultElement.className = "recommendation-result size-recommendation-down";
            } else {
                resultElement.className = "recommendation-result size-recommendation-neutral";
            }

            // æ˜¾ç¤ºå˜åŒ–è¯¦æƒ…
            const handicapChangeText = handicapChange > 0 ? `å¤§å°ç›˜ä¸Šå‡ ${Math.abs(handicapChange)}` :
                handicapChange < 0 ? `å¤§å°ç›˜ä¸‹é™ ${Math.abs(handicapChange)}` : "å¤§å°ç›˜æ— å˜åŒ–";
            const waterChangeText = waterChange > 0 ? `æ°´ä½ä¸Šå‡ ${Math.abs(waterChange.toFixed(2))}` :
                waterChange < 0 ? `æ°´ä½ä¸‹é™ ${Math.abs(waterChange.toFixed(2))}` : "æ°´ä½æ— å˜åŒ–";
            const historicalText = historicalRecord === "win" ? "å†å²æˆ˜ç»©: èµ¢" : "å†å²æˆ˜ç»©: è¾“";

            document.getElementById('size-recommendation-details').textContent =
                `${handicapChangeText} | ${waterChangeText} | ${historicalText}`;
        }

        // ============== ä¿å­˜è®°å½•åŠŸèƒ½ ============== //
        // ä¿å­˜è®©çƒç›˜è®°å½•
        function saveAsianRecord() {
            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            let username = 'guest';
            let userType = 'trial';

            if (currentUser) {
                username = currentUser.username;
                userType = currentUser.userType;
            } else {
                // ä¸ºæ¸¸å®¢ç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼ˆåŸºäºæ—¶é—´æˆ³ï¼‰
                username = 'guest_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 5);
            }

            // å¦‚æœæ˜¯è¯•ç”¨ç”¨æˆ·æˆ–æ¸¸å®¢ï¼Œè¿›è¡Œæ›´ä¸¥æ ¼çš„æ£€æŸ¥
            if (!currentUser || userType === 'trial') {
                // 1. æ£€æŸ¥è¯•ç”¨æ¬¡æ•°
                const canSave = UserSystem.canSaveRecord(username);
                if (!canSave) {
                    let message = 'è¯•ç”¨æ¬¡æ•°å·²ç”¨å®Œï¼ˆæœ€å¤š18æ¬¡ï¼‰ã€‚';

                    // æ£€æŸ¥å…·ä½“åŸå› 
                    const isExpired = StorageManager.isTrialExpired(username);
                    const restriction = StorageManager.isRestricted(username);

                    if (isExpired) {
                        message = 'è¯•ç”¨æœŸå·²è¿‡æœŸï¼ˆ7å¤©ï¼‰ã€‚';
                    } else if (restriction.restricted) {
                        message = `è´¦å·å—é™ï¼š${restriction.reason}ï¼Œå‰©ä½™ ${restriction.hoursLeft} å°æ—¶`;
                    }

                    alert(message + ' è¯·æ³¨å†Œæˆä¸ºä¼šå‘˜ç»§ç»­ä½¿ç”¨ï¼');
                    UserSystem.showRegisterModal();
                    return;
                }
            }

            // éªŒè¯æ•°æ®
            const matchName = document.getElementById('asian-match-name').value.trim(); // æ–°å¢èµ›äº‹åç§°
            const initialHandicap = document.getElementById('asian-initial-handicap').value;
            const currentHandicap = document.getElementById('asian-current-handicap').value;
            const initialWater = document.getElementById('asian-initial-water').value;
            const currentWater = document.getElementById('asian-current-water').value;
            const historicalRecord = document.getElementById('asian-historical-record').value;
            const recommendationResult = document.getElementById('asian-recommendation-result').textContent;

            // éªŒè¯æ•°æ®
            if (!matchName) {
                alert('è¯·å…ˆè¾“å…¥èµ›äº‹åç§°ï¼');
                return;
            }

            if (!initialHandicap || !currentHandicap || !initialWater || !currentWater || !historicalRecord ||
                recommendationResult === "ç­‰å¾…è¾“å…¥" || recommendationResult === "æ— æ˜ç¡®æ¨è") {
                alert('è¯·å…ˆå¡«å†™æ‰€æœ‰å­—æ®µå¹¶è·å–æ¨èç»“æœï¼');
                return;
            }

            // ç¡®å®šç”¨æˆ·ID
            let userId = 'guest';
            if (currentUser) {
                userId = currentUser.id;
                username = currentUser.username;
            }

            // åˆ›å»ºè®°å½•å¯¹è±¡
            const record = {
                id: Date.now(), // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºID
                handicapType: 'asian', // ç›˜å£ç±»å‹ï¼šasian=è®©çƒç›˜
                userId: userId,
                username: username,
                matchName: matchName, // æ–°å¢èµ›äº‹åç§°
                initialHandicap: initialHandicap,
                currentHandicap: currentHandicap,
                initialWater: initialWater,
                currentWater: currentWater,
                handicapChange: (parseFloat(currentHandicap) - parseFloat(initialHandicap)).toFixed(2),
                waterChange: (parseFloat(currentWater) - parseFloat(initialWater)).toFixed(2),
                historicalRecord: historicalRecord,
                recommendation: recommendationResult,
                actualResult: "", // å®é™…ç»“æœä¸ºç©ºï¼Œç”¨æˆ·å¯ä»¥åç»­ç¼–è¾‘
                timestamp: new Date().toLocaleString()
            };

            // ä»localStorageè·å–ç°æœ‰è®°å½•
            let history = JSON.parse(localStorage.getItem('football-handicap-history') || '[]');

            // æ·»åŠ æ–°è®°å½•
            history.push(record);

            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('football-handicap-history', JSON.stringify(history));

            // å¦‚æœæ˜¯è¯•ç”¨ç”¨æˆ·ï¼Œå¢åŠ è®°å½•æ¬¡æ•°
            if (!currentUser || userType === 'trial') {
                const success = UserSystem.incrementTrialRecord(username);
                if (!success) {
                    alert('ä¿å­˜å¤±è´¥ï¼šè¯•ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™æˆ–è¯•ç”¨æœŸå·²è¿‡æœŸï¼');

                    // å¦‚æœä¿å­˜å¤±è´¥ï¼Œç§»é™¤åˆšæ·»åŠ çš„è®°å½•
                    history = history.filter(r => r.id !== record.id);
                    localStorage.setItem('football-handicap-history', JSON.stringify(history));

                    return;
                }
            }

            // é‡æ–°åŠ è½½å†å²è®°å½•
            loadHistory();

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼ŒåŒ…å«è¯•ç”¨ä¿¡æ¯
            let successMsg = 'è®©çƒç›˜è®°å½•å·²ä¿å­˜ï¼';
            if (!currentUser || userType === 'trial') {
                const trialData = StorageManager.getTrialData(username);
                const usedCount = trialData ? trialData.count : 0;
                const remaining = 18 - usedCount;
                const remainingDays = StorageManager.getRemainingTrialDays(username);

                successMsg += `\n\nè¯•ç”¨ä¿¡æ¯ï¼š`;
                successMsg += `\nå·²ä½¿ç”¨æ¬¡æ•°ï¼š${usedCount}/18`;
                successMsg += `\nå‰©ä½™æ¬¡æ•°ï¼š${remaining}`;
                if (remainingDays < 7) {
                    successMsg += `\nè¯•ç”¨æœŸå‰©ä½™ï¼š${remainingDays}å¤©`;
                }
            }

            alert(successMsg);
        }

        // ä¿å­˜å¤§å°ç›˜è®°å½•
        function saveSizeRecord() {
            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            let username = 'guest';
            let userType = 'trial';

            if (currentUser) {
                username = currentUser.username;
                userType = currentUser.userType;
            } else {
                // ä¸ºæ¸¸å®¢ç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼ˆåŸºäºæ—¶é—´æˆ³ï¼‰
                username = 'guest_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 5);
            }

            // å¦‚æœæ˜¯è¯•ç”¨ç”¨æˆ·æˆ–æ¸¸å®¢ï¼Œè¿›è¡Œæ›´ä¸¥æ ¼çš„æ£€æŸ¥
            if (!currentUser || userType === 'trial') {
                // 1. æ£€æŸ¥è¯•ç”¨æ¬¡æ•°
                const canSave = UserSystem.canSaveRecord(username);
                if (!canSave) {
                    let message = 'è¯•ç”¨æ¬¡æ•°å·²ç”¨å®Œï¼ˆæœ€å¤š18æ¬¡ï¼‰ã€‚';

                    // æ£€æŸ¥å…·ä½“åŸå› 
                    const isExpired = StorageManager.isTrialExpired(username);
                    const restriction = StorageManager.isRestricted(username);

                    if (isExpired) {
                        message = 'è¯•ç”¨æœŸå·²è¿‡æœŸï¼ˆ7å¤©ï¼‰ã€‚';
                    } else if (restriction.restricted) {
                        message = `è´¦å·å—é™ï¼š${restriction.reason}ï¼Œå‰©ä½™ ${restriction.hoursLeft} å°æ—¶`;
                    }

                    alert(message + ' è¯·æ³¨å†Œæˆä¸ºä¼šå‘˜ç»§ç»­ä½¿ç”¨ï¼');
                    UserSystem.showRegisterModal();
                    return;
                }
            }

            // éªŒè¯æ•°æ®
            const matchName = document.getElementById('size-match-name').value.trim(); // æ–°å¢èµ›äº‹åç§°
            const initialHandicap = document.getElementById('size-initial-handicap').value;
            const currentHandicap = document.getElementById('size-current-handicap').value;
            const initialWater = document.getElementById('size-initial-water').value;
            const currentWater = document.getElementById('size-current-water').value;
            const historicalRecord = document.getElementById('size-historical-record').value;
            const recommendationResult = document.getElementById('size-recommendation-result').textContent;

            // éªŒè¯æ•°æ®
            if (!matchName) {
                alert('è¯·å…ˆè¾“å…¥èµ›äº‹åç§°ï¼');
                return;
            }

            if (!initialHandicap || !currentHandicap || !initialWater || !currentWater || !historicalRecord ||
                recommendationResult === "ç­‰å¾…è¾“å…¥" || recommendationResult === "æ— æ˜ç¡®æ¨è") {
                alert('è¯·å…ˆå¡«å†™æ‰€æœ‰å­—æ®µå¹¶è·å–æ¨èç»“æœï¼');
                return;
            }

            // ç¡®å®šç”¨æˆ·ID
            let userId = 'guest';
            if (currentUser) {
                userId = currentUser.id;
                username = currentUser.username;
            }

            // åˆ›å»ºè®°å½•å¯¹è±¡
            const record = {
                id: Date.now(), // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºID
                handicapType: 'size', // ç›˜å£ç±»å‹ï¼šsize=å¤§å°ç›˜
                userId: userId,
                username: username,
                matchName: matchName, // æ–°å¢èµ›äº‹åç§°
                initialHandicap: initialHandicap,
                currentHandicap: currentHandicap,
                initialWater: initialWater,
                currentWater: currentWater,
                handicapChange: (parseFloat(currentHandicap) - parseFloat(initialHandicap)).toFixed(2),
                waterChange: (parseFloat(currentWater) - parseFloat(initialWater)).toFixed(2),
                historicalRecord: historicalRecord,
                recommendation: recommendationResult,
                actualResult: "", // å®é™…ç»“æœä¸ºç©ºï¼Œç”¨æˆ·å¯ä»¥åç»­ç¼–è¾‘
                timestamp: new Date().toLocaleString()
            };

            // ä»localStorageè·å–ç°æœ‰è®°å½•
            let history = JSON.parse(localStorage.getItem('football-handicap-history') || '[]');

            // æ·»åŠ æ–°è®°å½•
            history.push(record);

            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('football-handicap-history', JSON.stringify(history));

            // å¦‚æœæ˜¯è¯•ç”¨ç”¨æˆ·ï¼Œå¢åŠ è®°å½•æ¬¡æ•°
            if (!currentUser || userType === 'trial') {
                const success = UserSystem.incrementTrialRecord(username);
                if (!success) {
                    alert('ä¿å­˜å¤±è´¥ï¼šè¯•ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™æˆ–è¯•ç”¨æœŸå·²è¿‡æœŸï¼');

                    // å¦‚æœä¿å­˜å¤±è´¥ï¼Œç§»é™¤åˆšæ·»åŠ çš„è®°å½•
                    history = history.filter(r => r.id !== record.id);
                    localStorage.setItem('football-handicap-history', JSON.stringify(history));

                    return;
                }
            }

            // é‡æ–°åŠ è½½å†å²è®°å½•
            loadHistory();

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼ŒåŒ…å«è¯•ç”¨ä¿¡æ¯
            let successMsg = 'å¤§å°ç›˜è®°å½•å·²ä¿å­˜ï¼';
            if (!currentUser || userType === 'trial') {
                const trialData = StorageManager.getTrialData(username);
                const usedCount = trialData ? trialData.count : 0;
                const remaining = 18 - usedCount;
                const remainingDays = StorageManager.getRemainingTrialDays(username);

                successMsg += `\n\nè¯•ç”¨ä¿¡æ¯ï¼š`;
                successMsg += `\nå·²ä½¿ç”¨æ¬¡æ•°ï¼š${usedCount}/18`;
                successMsg += `\nå‰©ä½™æ¬¡æ•°ï¼š${remaining}`;
                if (remainingDays < 7) {
                    successMsg += `\nè¯•ç”¨æœŸå‰©ä½™ï¼š${remainingDays}å¤©`;
                }
            }

            alert(successMsg);
        }

        // åŠ è½½å†å²è®°å½•ï¼ˆåªæ˜¾ç¤ºå½“å‰ç”¨æˆ·çš„è®°å½•ï¼‰
        function loadHistory() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            let history = JSON.parse(localStorage.getItem('football-handicap-history') || '[]');

            // è¿‡æ»¤å‡ºå½“å‰ç”¨æˆ·çš„è®°å½•
            if (currentUser) {
                history = history.filter(record => record.userId === currentUser.id);
            } else {
                history = history.filter(record => record.userId === 'guest' || record.userId.toString().includes('guest_'));
            }

            const tableBody = document.getElementById('history-table-body');
            // æ¸…ç©ºç°æœ‰å†…å®¹
            tableBody.innerHTML = '';

            // å¦‚æœæ²¡æœ‰è®°å½•
            if (history.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML =
                    `<td colspan="8" style="text-align: center; padding: 30px; font-size: 14px; color: #666;">æš‚æ— å†å²è®°å½•</td>`;
                tableBody.appendChild(row);
                updateChartData();
                return;
            }

            // æ·»åŠ è®°å½•è¡Œ
            history.forEach(record => {
                const row = document.createElement('tr');
                // ç¡®å®šå˜åŒ–çŠ¶æ€æ ·å¼
                const handicapChangeClass = parseFloat(record.handicapChange) > 0 ? 'status-up' :
                    parseFloat(record.handicapChange) < 0 ? 'status-down' : '';
                const waterChangeClass = parseFloat(record.waterChange) > 0 ? 'status-up' :
                    parseFloat(record.waterChange) < 0 ? 'status-down' : '';

                // ç›˜å£ç±»å‹æ˜¾ç¤º
                const handicapTypeText = record.handicapType === 'asian' ? 'è®©çƒç›˜' : 'å¤§å°ç›˜';
                const handicapTypeClass = record.handicapType === 'asian' ? 'status-up' : 'status-down';

                row.innerHTML = `
            <td>${record.matchName || 'æœªå‘½åèµ›äº‹'}</td>
            <td class="${handicapTypeClass}">${handicapTypeText}</td>
            <td class="${handicapChangeClass}">${parseFloat(record.handicapChange) > 0 ? 'â†‘ ' : parseFloat(record.handicapChange) < 0 ? 'â†“ ' : ''}${Math.abs(parseFloat(record.handicapChange)).toFixed(2)}</td>
            <td class="${waterChangeClass}">${parseFloat(record.waterChange) > 0 ? 'â†‘ ' : parseFloat(record.waterChange) < 0 ? 'â†“ ' : ''}${Math.abs(parseFloat(record.waterChange)).toFixed(2)}</td>
            <td>${record.historicalRecord === 'win' ? 'èµ¢' : 'è¾“'}</td>
            <td>${record.recommendation}</td>
            <td>
                <select class="actual-result-select" data-id="${record.id}" style="width: 70px; padding: 6px; font-size: 12px;">
                    <option value="">é€‰æ‹©</option>
                    <option value="win" ${record.actualResult === 'win' ? 'selected' : ''}>èµ¢</option>
                    <option value="loss" ${record.actualResult === 'loss' ? 'selected' : ''}>è¾“</option>
                </select>
            </td>
            <td style="white-space: nowrap;">
                <button class="record-action record-edit" data-id="${record.id}">ç¼–è¾‘</button>
                <button class="record-action record-delete" data-id="${record.id}">åˆ é™¤</button>
            </td>
        `;
                tableBody.appendChild(row);
            });

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('.actual-result-select').forEach(select => {
                select.addEventListener('change', function() {
                    updateActualResult(this.dataset.id, this.value);
                });
                // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šå¢åŠ è§¦æ‘¸äº‹ä»¶
                select.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                });
            });

            document.querySelectorAll('.record-edit').forEach(button => {
                button.addEventListener('click', function() {
                    editRecord(this.dataset.id);
                });
                button.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                });
            });

            document.querySelectorAll('.record-delete').forEach(button => {
                button.addEventListener('click', function() {
                    deleteRecord(this.dataset.id);
                });
                button.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                });
            });

            // æ›´æ–°å›¾è¡¨æ•°æ®
            updateChartData();
        }

        // æ›´æ–°å®é™…ç»“æœ
        function updateActualResult(id, result) {
            let history = JSON.parse(localStorage.getItem('football-handicap-history') || '[]');
            const index = history.findIndex(record => record.id == id);
            if (index !== -1) {
                history[index].actualResult = result;
                localStorage.setItem('football-handicap-history', JSON.stringify(history));
                updateChartData();
            }
        }

        // ç¼–è¾‘è®°å½•
        function editRecord(id) {
            let history = JSON.parse(localStorage.getItem('football-handicap-history') || '[]');
            const record = history.find(record => record.id == id);
            if (record) {
                // æ ¹æ®ç›˜å£ç±»å‹åˆ‡æ¢åˆ°å¯¹åº”çš„æ ‡ç­¾é¡µ
                if (record.handicapType === 'asian') {
                    // åˆ‡æ¢åˆ°è®©çƒç›˜æ ‡ç­¾
                    document.querySelector('.handicap-tab[data-tab="asian-handicap"]').click();

                    // å¡«å……è®©çƒç›˜è¡¨å•
                    document.getElementById('asian-match-name').value = record.matchName || '';
                    document.getElementById('asian-initial-handicap').value = record.initialHandicap;
                    document.getElementById('asian-current-handicap').value = record.currentHandicap;
                    document.getElementById('asian-initial-water').value = record.initialWater;
                    document.getElementById('asian-current-water').value = record.currentWater;
                    document.getElementById('asian-historical-record').value = record.historicalRecord;

                    // è‡ªåŠ¨è®¡ç®—æ¨èç»“æœ
                    setTimeout(() => {
                        autoCalculateAsianRecommendation();
                    }, 100);
                } else if (record.handicapType === 'size') {
                    // åˆ‡æ¢åˆ°å¤§å°ç›˜æ ‡ç­¾
                    document.querySelector('.handicap-tab[data-tab="over-under"]').click();

                    // å¡«å……å¤§å°ç›˜è¡¨å•
                    document.getElementById('size-match-name').value = record.matchName || '';
                    document.getElementById('size-initial-handicap').value = record.initialHandicap;
                    document.getElementById('size-current-handicap').value = record.currentHandicap;
                    document.getElementById('size-initial-water').value = record.initialWater;
                    document.getElementById('size-current-water').value = record.currentWater;
                    document.getElementById('size-historical-record').value = record.historicalRecord;

                    // è‡ªåŠ¨è®¡ç®—æ¨èç»“æœ
                    setTimeout(() => {
                        autoCalculateSizeRecommendation();
                    }, 100);
                }

                // åˆ é™¤åŸè®°å½•
                deleteRecord(id, false);
                alert('è®°å½•å·²åŠ è½½åˆ°è¡¨å•ä¸­ï¼Œå¯ä»¥ä¿®æ”¹åé‡æ–°ä¿å­˜ï¼');
            }
        }

        // åˆ é™¤è®°å½•
        function deleteRecord(id, showAlert = true) {
            let history = JSON.parse(localStorage.getItem('football-handicap-history') || '[]');
            history = history.filter(record => record.id != id);
            localStorage.setItem('football-handicap-history', JSON.stringify(history));
            loadHistory();
            if (showAlert) {
                alert('è®°å½•å·²åˆ é™¤ï¼');
            }
        }

        // æ›´æ–°å›¾è¡¨æ•°æ®
        function updateChartData() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            let history = JSON.parse(localStorage.getItem('football-handicap-history') || '[]');

            // è¿‡æ»¤å‡ºå½“å‰ç”¨æˆ·çš„è®°å½•
            if (currentUser) {
                history = history.filter(record => record.userId === currentUser.id);
            } else {
                history = history.filter(record => record.userId === 'guest' || record.userId.toString().includes('guest_'));
            }

            // å¦‚æœæ²¡æœ‰è®°å½•ï¼Œé‡ç½®å›¾è¡¨
            if (history.length === 0) {
                updateChart([0, 0, 0, 0, 0]);
                return;
            }

            // è®¡ç®—ç»Ÿè®¡
            let waterUpTotal = 0;
            let waterUpWins = 0;
            let waterDownTotal = 0;
            let waterDownWins = 0;
            let handicapUpTotal = 0;
            let handicapUpWins = 0;
            let handicapDownTotal = 0;
            let handicapDownWins = 0;
            let lowWaterTotal = 0; // å³æ—¶æ°´ä½ä½äº0.90çš„æ€»è®°å½•æ•°
            let lowWaterWins = 0; // å³æ—¶æ°´ä½ä½äº0.90çš„èµ¢çš„è®°å½•æ•°

            history.forEach(record => {
                const waterChange = parseFloat(record.waterChange);
                const handicapChange = parseFloat(record.handicapChange);
                const currentWater = parseFloat(record.currentWater);
                const actualResult = record.actualResult;

                // åªç»Ÿè®¡æœ‰å®é™…ç»“æœçš„è®°å½•
                if (actualResult) {
                    // æ°´ä½å˜åŒ–ç»Ÿè®¡
                    if (waterChange > 0) {
                        waterUpTotal++;
                        if (actualResult === 'win') waterUpWins++;
                    } else if (waterChange < 0) {
                        waterDownTotal++;
                        if (actualResult === 'win') waterDownWins++;
                    }

                    // ç›˜å£å˜åŒ–ç»Ÿè®¡
                    if (handicapChange > 0) {
                        handicapUpTotal++;
                        if (actualResult === 'win') handicapUpWins++;
                    } else if (handicapChange < 0) {
                        handicapDownTotal++;
                        if (actualResult === 'win') handicapDownWins++;
                    }

                    // å³æ—¶æ°´ä½ä½äº0.90çš„ç»Ÿè®¡
                    if (currentWater < 0.90) {
                        lowWaterTotal++;
                        if (actualResult === 'win') lowWaterWins++;
                    }
                }
            });

            // è®¡ç®—èƒœç‡
            const waterUpWinRate = waterUpTotal > 0 ? Math.round((waterUpWins / waterUpTotal) * 100) : 0;
            const waterDownWinRate = waterDownTotal > 0 ? Math.round((waterDownWins / waterDownTotal) * 100) : 0;
            const handicapUpWinRate = handicapUpTotal > 0 ? Math.round((handicapUpWins / handicapUpTotal) * 100) : 0;
            const handicapDownWinRate = handicapDownTotal > 0 ? Math.round((handicapDownWins / handicapDownTotal) * 100) : 0;
            const lowWaterWinRate = lowWaterTotal > 0 ? Math.round((lowWaterWins / lowWaterTotal) * 100) : 0;

            // æ›´æ–°å›¾è¡¨
            updateChart([waterUpWinRate, waterDownWinRate, handicapUpWinRate, handicapDownWinRate, lowWaterWinRate]);
        }

        // å›¾è¡¨å˜é‡
        let statsChart = null;

        // åˆå§‹åŒ–å›¾è¡¨ - ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆæœ¬
        function initChart() {
            const ctx = document.getElementById('stats-chart').getContext('2d');
            // æ£€æµ‹æ˜¯å¦æ˜¯ç§»åŠ¨è®¾å¤‡
            const isMobile = window.innerWidth <= 768;
            statsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['æ°´ä½ä¸Šå‡', 'æ°´ä½ä¸‹é™', 'ç›˜å£ä¸Šå‡', 'ç›˜å£ä¸‹é™', 'æ°´ä½<0.90'],
                    datasets: [{
                        label: 'èƒœç‡ (%)',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.7)', // ç»¿è‰² - æ°´ä½ä¸Šå‡
                            'rgba(220, 53, 69, 0.7)', // çº¢è‰² - æ°´ä½ä¸‹é™
                            'rgba(0, 123, 255, 0.7)', // è“è‰² - ç›˜å£ä¸Šå‡
                            'rgba(255, 193, 7, 0.7)', // é»„è‰² - ç›˜å£ä¸‹é™
                            'rgba(111, 66, 193, 0.7)' // ç´«è‰² - æ°´ä½<0.90
                        ],
                        borderColor: [
                            'rgb(40, 167, 69)',
                            'rgb(220, 53, 69)',
                            'rgb(0, 123, 255)',
                            'rgb(255, 193, 7)',
                            'rgb(111, 66, 193)'
                        ],
                        borderWidth: 1,
                        barPercentage: isMobile ? 0.6 : 0.8, // ç§»åŠ¨ç«¯æ›´çª„çš„æŸ±çŠ¶å›¾
                        categoryPercentage: isMobile ? 0.7 : 0.9
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: {
                                    size: isMobile ? 10 : 12
                                },
                                padding: 5
                            },
                            title: {
                                display: true,
                                text: 'èƒœç‡ (%)',
                                font: {
                                    size: isMobile ? 12 : 14
                                }
                            },
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: isMobile ? 10 : 12
                                },
                                maxRotation: isMobile ? 45 : 0,
                                minRotation: isMobile ? 45 : 0
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.raw + '%';
                                }
                            },
                            titleFont: {
                                size: isMobile ? 12 : 14
                            },
                            bodyFont: {
                                size: isMobile ? 12 : 14
                            },
                            padding: isMobile ? 8 : 12
                        },
                        title: {
                            display: true,
                            text: 'èƒœç‡ç»Ÿè®¡å›¾è¡¨ï¼ˆåŒ…å«è®©çƒç›˜å’Œå¤§å°ç›˜ï¼‰',
                            font: {
                                size: isMobile ? 14 : 16
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œè°ƒæ•´å›¾è¡¨
            window.addEventListener('resize', function() {
                if (statsChart) {
                    statsChart.resize();
                }
            });
        }

        // æ›´æ–°å›¾è¡¨æ•°æ®
        function updateChart(data) {
            if (statsChart) {
                statsChart.data.datasets[0].data = data;
                statsChart.update();
            }
        }

        // é‡ç½®è¡¨å•
        function resetAsianForm() {
            document.getElementById('asian-match-name').value = '';
            document.getElementById('asian-initial-handicap').value = '';
            document.getElementById('asian-current-handicap').value = '';
            document.getElementById('asian-initial-water').value = '';
            document.getElementById('asian-current-water').value = '';
            document.getElementById('asian-historical-record').value = '';
            document.getElementById('asian-recommendation-result').textContent = 'ç­‰å¾…è¾“å…¥';
            document.getElementById('asian-recommendation-result').className =
            'recommendation-result recommendation-neutral';
            document.getElementById('asian-recommendation-details').textContent = 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µä»¥è·å–æ¨èç»“æœ';
        }

        function resetSizeForm() {
            document.getElementById('size-match-name').value = '';
            document.getElementById('size-initial-handicap').value = '';
            document.getElementById('size-current-handicap').value = '';
            document.getElementById('size-initial-water').value = '';
            document.getElementById('size-current-water').value = '';
            document.getElementById('size-historical-record').value = '';
            document.getElementById('size-recommendation-result').textContent = 'ç­‰å¾…è¾“å…¥';
            document.getElementById('size-recommendation-result').className =
                'recommendation-result size-recommendation-neutral';
            document.getElementById('size-recommendation-details').textContent = 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µä»¥è·å–æ¨èç»“æœ';
        }

        // åˆ‡æ¢å†å²è®°å½•æ˜¾ç¤º/éšè—
        function toggleHistory() {
            const historyContent = document.getElementById('history-content');
            const toggleButton = document.getElementById('toggle-history');
            if (historyContent.classList.contains('hidden')) {
                historyContent.classList.remove('hidden');
                toggleButton.textContent = 'éšè—è®°å½•';
            } else {
                historyContent.classList.add('hidden');
                toggleButton.textContent = 'æ˜¾ç¤ºè®°å½•';
            }
        }

        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            let history = JSON.parse(localStorage.getItem('football-handicap-history') || '[]');
            if (currentUser) {
                // åªæ¸…ç©ºå½“å‰ç”¨æˆ·çš„è®°å½•
                history = history.filter(record => record.userId !== currentUser.id);
            } else {
                // æ¸…ç©ºæ¸¸å®¢è®°å½•
                history = history.filter(record => record.userId !== 'guest' && !record.userId.toString().includes(
                'guest_'));
            }
            localStorage.setItem('football-handicap-history', JSON.stringify(history));
            loadHistory();
            alert('å†å²è®°å½•å·²æ¸…ç©ºï¼');
        }
    </script>
</body>
</html>